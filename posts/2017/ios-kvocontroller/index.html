<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>KVO & KVOController | RoninRo's Blog</title><meta name=author content="RoninRo"><meta name=description content="KVO的实现机制KVO 是 Objective-C 对观察者模式的实现。从苹果的 文档 中对于它的实现描述可以知道： KVO 是通过 isa-swizzling 实现的。 当你观察一个对象时，该对象的isa指"><meta name=keywords content="blog,developer,personal,golang"><meta name=twitter:card content="summary"><meta name=twitter:title content="KVO & KVOController"><meta name=twitter:description content="KVO的实现机制KVO 是 Objective-C 对观察者模式的实现。从苹果的 文档 中对于它的实现描述可以知道： KVO 是通过 isa-swizzling 实现的。 当你观察一个对象时，该对象的isa指"><meta property="og:title" content="KVO & KVOController"><meta property="og:description" content="KVO的实现机制KVO 是 Objective-C 对观察者模式的实现。从苹果的 文档 中对于它的实现描述可以知道： KVO 是通过 isa-swizzling 实现的。 当你观察一个对象时，该对象的isa指"><meta property="og:type" content="article"><meta property="og:url" content="https://fninit.com/posts/2017/ios-kvocontroller/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-06-30T11:08:26+08:00"><meta property="article:modified_time" content="2017-07-05T00:00:00+00:00"><link rel=stylesheet href=/css/bootstrap.min.css crossorigin=anonymous><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://fninit.com/sass/main.css><link rel=stylesheet href=https://fninit.com/zoomjs/zoom.min.css></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://fninit.com>RoninRo's Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/ title=Home>Home</a></li><li><a href=/archive/ title=Archive>Archive</a></li><li><a href=/categories/ title=Categories>Categories</a></li><li><a href=/about/ title=About>About</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=https://fninit.com/tags/kvocontroller/ title=KVOController>KVOController</a>
<a class=tag href=https://fninit.com/tags/ios/ title=iOS>iOS</a></div><h1>KVO & KVOController</h1><h2 class=subheading></h2><p class=post-meta>Posted by RoninRo
on Fri, Jun 30, 2017</p></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h3 id=kvo的实现机制>KVO的实现机制<a class=anchorjs-link href=#kvo%e7%9a%84%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6></a></h3><p>KVO 是 Objective-C 对观察者模式的实现。从苹果的
<a href=https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html>文档</a>
中对于它的实现描述可以知道： KVO 是通过 isa-swizzling 实现的。
当你观察一个对象时，该对象的isa指针被修改，指向一个中间类，而不是其真实的类。但是具体的实现苹果的文档里并没有详细说明。</p><p>事实上，这个中间类会在对象被观察时动态地被创建。继承自该对象原来的类，并且重写被观察属性的 setter 方法。重写的方法负责在调用原 setter 方法之前和之后，通知所有观察对象值的更改。然后将 isa 指针指向新创建的类。这样对象就变成了新创建的子类的实例了。</p><p>参考 Mike Ash 的 <a href=https://www.mikeash.com/pyblog/friday-qa-2009-01-23.html>Friday Q&A 2009-01-23</a>。</p><p><a href=https://github.com/mjyi/blogdemos/tree/master/kvo>测试代码地址</a></p><h3 id=kvo-的缺点>KVO 的缺点<a class=anchorjs-link href=#kvo-%e7%9a%84%e7%bc%ba%e7%82%b9></a></h3><p>KVO的缺点在于它的API，我们只能通过
observeValueForKeyPath: ofObject: change: context: 来获得通知。无法通过自定义 selector 或 block 来处理通知事件。因此我们可能需要一些判断来处理不同的情况。</p><p>在了解了kov的实现机制后，我们可以使用block实现KVO.</p><p>参考：<a href=https://knightsj.github.io/2017/05/15/%E4%BD%BF%E7%94%A8Block%E5%AE%9E%E7%8E%B0KVO/>使用Block实现KVO</a> 、
<a href=http://tech.glowing.com/cn/implement-kvo/>如何自己动手实现 KVO</a></p><h3 id=kvocontroller>KVOController<a class=anchorjs-link href=#kvocontroller></a></h3><p><a href=https://github.com/facebook/KVOController>KVOController</a>是Facebook 推出的一个开源库。它是基于 Cocoa 的KVO 的一次封装，提供简单的API，并且是线程安全的。</p><p>使用方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#6272a4>// create KVO controller with observer
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#6272a4></span>FBKVOController <span style=color:#ff79c6>*</span>KVOController <span style=color:#ff79c6>=</span> [FBKVOController <span style=color:#8be9fd;font-style:italic>controllerWithObserver</span>:<span style=color:#8be9fd;font-style:italic>self</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd;font-style:italic>self</span>.KVOController <span style=color:#ff79c6>=</span> KVOController;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#6272a4>// observe clock date property
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#6272a4></span>[<span style=color:#8be9fd;font-style:italic>self</span>.KVOController <span style=color:#8be9fd;font-style:italic>observe</span>:clock <span style=color:#8be9fd;font-style:italic>keyPath</span>:<span style=color:#f1fa8c>@&#34;date&#34;</span> <span style=color:#8be9fd;font-style:italic>options</span>:NSKeyValueObservingOptionInitial<span style=color:#ff79c6>|</span>NSKeyValueObservingOptionNew <span style=color:#8be9fd;font-style:italic>block</span>:<span style=color:#ff79c6>^</span>(ClockView <span style=color:#ff79c6>*</span>clockView, Clock <span style=color:#ff79c6>*</span>clock, NSDictionary <span style=color:#ff79c6>*</span>change) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  <span style=color:#6272a4>// update clock view with new value
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#6272a4></span>  clockView.date <span style=color:#ff79c6>=</span> change[NSKeyValueChangeNewKey];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}];
</span></span></code></pre></div><p>在使用 KVOController时，我们不需要关注在何时移除观察者，因为KVOController会在dealloc时自动将其移除。
使用 block 来处理KVO的通知事件，更是一种美好的体验。</p><h4 id=项目结构>项目结构<a class=anchorjs-link href=#%e9%a1%b9%e7%9b%ae%e7%bb%93%e6%9e%84></a></h4><p>KVOController 整个项目结构只能有5个文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>├── KVOController.h
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>├── FBKVOController.h
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>├── FBKVOController.m
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>├── NSObject<span style=color:#ff79c6>+</span>FBKVOController.h
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>└── NSObject<span style=color:#ff79c6>+</span>FBKVOController.m
</span></span></code></pre></div><p>其中，KVOController.h 是头文件，NSObject+FBKVOController 通过 AssociateObject 为 NSObject 提供一个 retain 和 非retain 类型的KVOController。 FBKVOController文件就是主要的技术实现。</p><p>在 FBKVOController 文件中主要定义了三个类：</p><ul><li>_FBKVOInfo</li><li>_FBKVOSharedController</li><li>_KVOController</li></ul><h4 id=fbkvocontroller>FBKVOController<a class=anchorjs-link href=#fbkvocontroller></a></h4><p>成员变量以及初始化方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#6272a4> The observer notified on key-value change. Specified on initialization.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>@property</span> (nullable, <span style=color:#ff79c6>nonatomic</span>, <span style=color:#ff79c6>weak</span>, <span style=color:#ff79c6>readonly</span>) <span style=color:#8be9fd>id</span> observer;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>@implementation</span> <span style=color:#50fa7b>FBKVOController</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  NSMapTable<span style=color:#ff79c6>&lt;</span><span style=color:#8be9fd>id</span>, NSMutableSet<span style=color:#ff79c6>&lt;</span>_FBKVOInfo <span style=color:#ff79c6>*&gt;</span> <span style=color:#ff79c6>*&gt;</span> <span style=color:#ff79c6>*</span>_objectInfosMap;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  pthread_mutex_t _lock;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>- (<span style=color:#8be9fd>instancetype</span>)<span style=color:#50fa7b>initWithObserver:</span>(nullable <span style=color:#8be9fd>id</span>)<span style=color:#8be9fd;font-style:italic>observer</span> <span style=color:#50fa7b>retainObserved:</span>(<span style=color:#8be9fd>BOOL</span>)<span style=color:#8be9fd;font-style:italic>retainObserved</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#8be9fd;font-style:italic>self</span> <span style=color:#ff79c6>=</span> [<span style=color:#8be9fd;font-style:italic>super</span> init];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>!=</span> <span style=color:#8be9fd;font-style:italic>self</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    _observer <span style=color:#ff79c6>=</span> observer;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    NSPointerFunctionsOptions keyOptions <span style=color:#ff79c6>=</span> retainObserved <span style=color:#ff79c6>?</span> NSPointerFunctionsStrongMemory<span style=color:#ff79c6>|</span><span style=color:#8be9fd;font-style:italic>NSPointerFunctionsObjectPointerPersonality</span> : NSPointerFunctionsWeakMemory<span style=color:#ff79c6>|</span>NSPointerFunctionsObjectPointerPersonality;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    _objectInfosMap <span style=color:#ff79c6>=</span> [[NSMapTable alloc] <span style=color:#8be9fd;font-style:italic>initWithKeyOptions</span>:keyOptions <span style=color:#8be9fd;font-style:italic>valueOptions</span>:NSPointerFunctionsStrongMemory<span style=color:#ff79c6>|</span>NSPointerFunctionsObjectPersonality <span style=color:#8be9fd;font-style:italic>capacity</span>:<span style=color:#bd93f9>0</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    pthread_mutex_init(<span style=color:#ff79c6>&amp;</span>_lock, <span style=color:#8be9fd;font-style:italic>NULL</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>self</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span></code></pre></div><ol><li>KVOController 维护了一个对观察者的弱引用,在初始化时，传入的observer赋值给_observer进行weak持有。</li></ol><ul><li>NSMapTable, 和NSDictionary 类似，但是是一个object-object的映射关系，并且可以指定 key、value的strong，weak 或者 copy 类型。通过retainObserved参数来生成对应的weak或者strong的NSPointerFunctionsOptions</li><li>_lock 互斥锁，保证线程安全。</li></ul><p>FBKVOController对观察对象 add Observer</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>- (<span style=color:#8be9fd>void</span>)<span style=color:#50fa7b>observe:</span>(nullable <span style=color:#8be9fd>id</span>)<span style=color:#8be9fd;font-style:italic>object</span> <span style=color:#50fa7b>keyPath:</span>(NSString <span style=color:#ff79c6>*</span>)<span style=color:#8be9fd;font-style:italic>keyPath</span> <span style=color:#50fa7b>options:</span>(NSKeyValueObservingOptions)<span style=color:#8be9fd;font-style:italic>options</span> <span style=color:#50fa7b>block:</span>(FBKVONotificationBlock)<span style=color:#8be9fd;font-style:italic>block</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  NSAssert(<span style=color:#bd93f9>0</span> <span style=color:#ff79c6>!=</span> keyPath.length <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>!=</span> block, <span style=color:#f1fa8c>@&#34;missing required parameters observe:%@ keyPath:%@ block:%p&#34;</span>, object, keyPath, block);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>==</span> object <span style=color:#ff79c6>||</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>==</span> keyPath.length <span style=color:#ff79c6>||</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>==</span> block) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#6272a4>// create info
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>  _FBKVOInfo <span style=color:#ff79c6>*</span>info <span style=color:#ff79c6>=</span> [[_FBKVOInfo alloc] <span style=color:#8be9fd;font-style:italic>initWithController</span>:<span style=color:#8be9fd;font-style:italic>self</span> <span style=color:#8be9fd;font-style:italic>keyPath</span>:keyPath <span style=color:#8be9fd;font-style:italic>options</span>:options <span style=color:#8be9fd;font-style:italic>block</span>:block];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#6272a4>// observe object with info
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#6272a4></span>  [<span style=color:#8be9fd;font-style:italic>self</span> <span style=color:#8be9fd;font-style:italic>_observe</span>:object <span style=color:#8be9fd;font-style:italic>info</span>:info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>- (<span style=color:#8be9fd>void</span>)<span style=color:#50fa7b>_observe:</span>(<span style=color:#8be9fd>id</span>)<span style=color:#8be9fd;font-style:italic>object</span> <span style=color:#50fa7b>info:</span>(_FBKVOInfo <span style=color:#ff79c6>*</span>)<span style=color:#8be9fd;font-style:italic>info</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#6272a4>// lock
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#6272a4></span>  pthread_mutex_lock(<span style=color:#ff79c6>&amp;</span>_lock);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>  NSMutableSet <span style=color:#ff79c6>*</span>infos <span style=color:#ff79c6>=</span> [_objectInfosMap <span style=color:#8be9fd;font-style:italic>objectForKey</span>:object];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>  <span style=color:#6272a4>// check for info existence
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>  _FBKVOInfo <span style=color:#ff79c6>*</span>existingInfo <span style=color:#ff79c6>=</span> [infos <span style=color:#8be9fd;font-style:italic>member</span>:info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>!=</span> existingInfo) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#6272a4>// observation info already exists; do not observe it again
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#6272a4>// unlock and return
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#6272a4></span>    pthread_mutex_unlock(<span style=color:#ff79c6>&amp;</span>_lock);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>  <span style=color:#6272a4>// lazilly create set of infos
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>==</span> infos) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    infos <span style=color:#ff79c6>=</span> [NSMutableSet set];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    [_objectInfosMap <span style=color:#8be9fd;font-style:italic>setObject</span>:infos <span style=color:#8be9fd;font-style:italic>forKey</span>:object];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>  <span style=color:#6272a4>// add info and oberve
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#6272a4></span>  [infos <span style=color:#8be9fd;font-style:italic>addObject</span>:info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>  <span style=color:#6272a4>// unlock prior to callout
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#6272a4></span>  pthread_mutex_unlock(<span style=color:#ff79c6>&amp;</span>_lock);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>  [[_FBKVOSharedController sharedController] <span style=color:#8be9fd;font-style:italic>observe</span>:object <span style=color:#8be9fd;font-style:italic>info</span>:info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>}
</span></span></code></pre></div><p>代码中对于实现思路做了很好的注释：</p><ol><li>首先对于传入的操作进行断言判断。</li></ol><ul><li>使用传入参数创建 _FBKVOInfo 实例 info。对info 添加观察[self _observe:object info:info];。</li><li>对_objectInfosMap 进行检查，避免重复添加。并在读写时使用加锁，保证线程安全。</li><li>添加成功后调用 [[_FBKVOSharedController sharedController] observe:object info:info]</li></ul><p>实现隐式地移除KVO：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>- (<span style=color:#8be9fd>void</span>)<span style=color:#50fa7b>dealloc</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  [<span style=color:#8be9fd;font-style:italic>self</span> unobserveAll];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  pthread_mutex_destroy(<span style=color:#ff79c6>&amp;</span>_lock);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>- (<span style=color:#8be9fd>void</span>)<span style=color:#50fa7b>_unobserveAll</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#6272a4>// lock
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#6272a4></span>  pthread_mutex_lock(<span style=color:#ff79c6>&amp;</span>_lock);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  NSMapTable <span style=color:#ff79c6>*</span>objectInfoMaps <span style=color:#ff79c6>=</span> [_objectInfosMap <span style=color:#ff79c6>copy</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#6272a4>// clear table and map
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>  [_objectInfosMap removeAllObjects];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#6272a4>// unlock
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#6272a4></span>  pthread_mutex_unlock(<span style=color:#ff79c6>&amp;</span>_lock);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  _FBKVOSharedController <span style=color:#ff79c6>*</span>shareController <span style=color:#ff79c6>=</span> [_FBKVOSharedController sharedController];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>  <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>id</span> object <span style=color:#ff79c6>in</span> objectInfoMaps) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#6272a4>// unobserve each registered object and infos
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#6272a4></span>    NSSet <span style=color:#ff79c6>*</span>infos <span style=color:#ff79c6>=</span> [objectInfoMaps <span style=color:#8be9fd;font-style:italic>objectForKey</span>:object];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    [shareController <span style=color:#8be9fd;font-style:italic>unobserve</span>:object <span style=color:#8be9fd;font-style:italic>infos</span>:infos];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>}
</span></span></code></pre></div><p>在 KVOController 释放的时候，从_FBKVOSharedController单例中移除 observer</p><h4 id=_fbkvosharedcontroller>_FBKVOSharedController<a class=anchorjs-link href=#_fbkvosharedcontroller></a></h4><p>_FBKVOSharedController 被设计成单例，统一管理KVO通知的接收和转发。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>@implementation</span> <span style=color:#50fa7b>_FBKVOSharedController</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  NSHashTable<span style=color:#ff79c6>&lt;</span>_FBKVOInfo <span style=color:#ff79c6>*&gt;</span> <span style=color:#ff79c6>*</span>_infos;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  pthread_mutex_t _mutex;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><ul><li>_infos: NSHashTable类型，类似NSSet，同样也可以设置对象的强弱引用。</li><li>_mutex： 互斥锁，为了线程安全。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>- (<span style=color:#8be9fd>void</span>)<span style=color:#50fa7b>observe:</span>(<span style=color:#8be9fd>id</span>)<span style=color:#8be9fd;font-style:italic>object</span> <span style=color:#50fa7b>info:</span>(nullable _FBKVOInfo <span style=color:#ff79c6>*</span>)<span style=color:#8be9fd;font-style:italic>info</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>==</span> info) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#6272a4>// register info
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>  pthread_mutex_lock(<span style=color:#ff79c6>&amp;</span>_mutex);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  [_infos <span style=color:#8be9fd;font-style:italic>addObject</span>:info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  pthread_mutex_unlock(<span style=color:#ff79c6>&amp;</span>_mutex);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#6272a4>// add observer
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>  [object <span style=color:#8be9fd;font-style:italic>addObserver</span>:<span style=color:#8be9fd;font-style:italic>self</span> <span style=color:#8be9fd;font-style:italic>forKeyPath</span>:info<span style=color:#ff79c6>-&gt;</span>_keyPath <span style=color:#8be9fd;font-style:italic>options</span>:info<span style=color:#ff79c6>-&gt;</span>_options <span style=color:#8be9fd;font-style:italic>context</span>:(<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>)info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#ff79c6>if</span> (info<span style=color:#ff79c6>-&gt;</span>_state <span style=color:#ff79c6>==</span> _FBKVOInfoStateInitial) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    info<span style=color:#ff79c6>-&gt;</span>_state <span style=color:#ff79c6>=</span> _FBKVOInfoStateObserving;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (info<span style=color:#ff79c6>-&gt;</span>_state <span style=color:#ff79c6>==</span> _FBKVOInfoStateNotObserving) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    [object <span style=color:#8be9fd;font-style:italic>removeObserver</span>:<span style=color:#8be9fd;font-style:italic>self</span> <span style=color:#8be9fd;font-style:italic>forKeyPath</span>:info<span style=color:#ff79c6>-&gt;</span>_keyPath <span style=color:#8be9fd;font-style:italic>context</span>:(<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>)info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span></code></pre></div><ul><li>将 info 加入 _infos.</li><li>[object addObserver:self forKeyPath:info->_keyPath options:info->_options context:(void *)info] 为object 添加观察者。</li></ul><p>在 _FBKVOSharedController 实现observeValueForKeyPath:ofObject:Change:context 接收处理通知。</p><p><strong>info = [_infos member:(__bridge id)context];</strong>
在 _infos 中找到当前 _FBKVOInfo,并对它进行一个强引用。对数据进行封装，执行注册的回调。block， selector, 默认方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>!=</span> info) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#6272a4>// take strong reference to controller
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#6272a4></span>    FBKVOController <span style=color:#ff79c6>*</span>controller <span style=color:#ff79c6>=</span> info<span style=color:#ff79c6>-&gt;</span>_controller;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>!=</span> controller) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      <span style=color:#6272a4>// take strong reference to observer
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#6272a4></span>      <span style=color:#8be9fd>id</span> observer <span style=color:#ff79c6>=</span> controller.observer;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>!=</span> observer) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#6272a4>// dispatch custom block or action, fall back to default action
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> (info<span style=color:#ff79c6>-&gt;</span>_block) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>          NSDictionary<span style=color:#ff79c6>&lt;</span>NSKeyValueChangeKey, <span style=color:#8be9fd>id</span><span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>*</span>changeWithKeyPath <span style=color:#ff79c6>=</span> change;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>          <span style=color:#6272a4>// add the keyPath to the change dictionary for clarity when mulitple keyPaths are being observed
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#6272a4></span>          <span style=color:#ff79c6>if</span> (keyPath) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            NSMutableDictionary<span style=color:#ff79c6>&lt;</span>NSString <span style=color:#ff79c6>*</span>, <span style=color:#8be9fd>id</span><span style=color:#ff79c6>&gt;</span> <span style=color:#ff79c6>*</span>mChange <span style=color:#ff79c6>=</span> [NSMutableDictionary <span style=color:#8be9fd;font-style:italic>dictionaryWithObject</span>:keyPath <span style=color:#8be9fd;font-style:italic>forKey</span>:FBKVONotificationKeyPathKey];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            [mChange <span style=color:#8be9fd;font-style:italic>addEntriesFromDictionary</span>:change];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            changeWithKeyPath <span style=color:#ff79c6>=</span> [mChange <span style=color:#ff79c6>copy</span>];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>          }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>          info<span style=color:#ff79c6>-&gt;</span>_block(observer, object, changeWithKeyPath);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (info<span style=color:#ff79c6>-&gt;</span>_action) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#ff79c6>#pragma clang diagnostic push
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#ff79c6>#pragma clang diagnostic ignored &#34;-Warc-performSelector-leaks&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#ff79c6></span>          [observer <span style=color:#8be9fd;font-style:italic>performSelector</span>:info<span style=color:#ff79c6>-&gt;</span>_action <span style=color:#8be9fd;font-style:italic>withObject</span>:change <span style=color:#8be9fd;font-style:italic>withObject</span>:object];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#ff79c6>#pragma clang diagnostic pop
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#ff79c6></span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>          [observer <span style=color:#8be9fd;font-style:italic>observeValueForKeyPath</span>:keyPath <span style=color:#8be9fd;font-style:italic>ofObject</span>:object <span style=color:#8be9fd;font-style:italic>change</span>:change <span style=color:#8be9fd;font-style:italic>context</span>:info<span style=color:#ff79c6>-&gt;</span>_context];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  }
</span></span></code></pre></div><p><strong>unobserve</strong> ,在KVOController <em>dealloc()</em> 时会将 info 从 _infos中移除，并用移除观察者 ，从而实现隐式地移除KVO。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>- (<span style=color:#8be9fd>void</span>)<span style=color:#50fa7b>unobserve:</span>(<span style=color:#8be9fd>id</span>)<span style=color:#8be9fd;font-style:italic>object</span> <span style=color:#50fa7b>info:</span>(nullable _FBKVOInfo <span style=color:#ff79c6>*</span>)<span style=color:#8be9fd;font-style:italic>info</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#ff79c6>if</span> (<span style=color:#8be9fd;font-style:italic>nil</span> <span style=color:#ff79c6>==</span> info) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#6272a4>// unregister info
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#6272a4></span>  pthread_mutex_lock(<span style=color:#ff79c6>&amp;</span>_mutex);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  [_infos <span style=color:#8be9fd;font-style:italic>removeObject</span>:info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  pthread_mutex_unlock(<span style=color:#ff79c6>&amp;</span>_mutex);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#6272a4>// remove observer
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#6272a4></span>  <span style=color:#ff79c6>if</span> (info<span style=color:#ff79c6>-&gt;</span>_state <span style=color:#ff79c6>==</span> _FBKVOInfoStateObserving) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    [object <span style=color:#8be9fd;font-style:italic>removeObserver</span>:<span style=color:#8be9fd;font-style:italic>self</span> <span style=color:#8be9fd;font-style:italic>forKeyPath</span>:info<span style=color:#ff79c6>-&gt;</span>_keyPath <span style=color:#8be9fd;font-style:italic>context</span>:(<span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>)info];
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  info<span style=color:#ff79c6>-&gt;</span>_state <span style=color:#ff79c6>=</span> _FBKVOInfoStateNotObserving;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span></code></pre></div><h4 id=_fbkvoinfo>_FBKVOInfo<a class=anchorjs-link href=#_fbkvoinfo></a></h4><p>_FBKVOInfo 将 将观察者信息保存在一起，并且重写了 hash 和 isEqual，以 _keyPath作为唯一性判断依据。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>@implementation</span> <span style=color:#50fa7b>_FBKVOInfo</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>@public</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#ff79c6>__weak</span> FBKVOController <span style=color:#ff79c6>*</span>_controller;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  NSString <span style=color:#ff79c6>*</span>_keyPath;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  NSKeyValueObservingOptions _options;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#8be9fd>SEL</span> _action;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#8be9fd>void</span> <span style=color:#ff79c6>*</span>_context;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  FBKVONotificationBlock _block;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  _FBKVOInfoState _state;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><h3 id=reference>Reference<a class=anchorjs-link href=#reference></a></h3><p><a href=https://github.com/facebook/KVOController>KVOController</a><br><a href=http://draveness.me/kvocontroller.html>如何优雅地使用KVO</a></p><p>[EOF]</p><hr style=visibility:hidden><ul class=pager><li class=previous><a href=https://fninit.com/posts/2017/ios-carthage/ data-toggle=tooltip data-placement=top title="Carthage 的简单使用">Previous<br><span>Carthage 的简单使用</span></a></li><li class=next><a href=https://fninit.com/posts/2017/linux-vimrc/ data-toggle=tooltip data-placement=top title=关于Vim不能正常显示中文的解决方法>Next<br><span>关于Vim不能正常显示中文的解决方法</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=https://fninit.com/tags/css/>css</a>
<a href=https://fninit.com/tags/debian/>debian</a>
<a href=https://fninit.com/tags/fzf/>fzf</a>
<a href=https://fninit.com/tags/gcd/>gcd</a>
<a href=https://fninit.com/tags/gem/>gem</a>
<a href=https://fninit.com/tags/git/>git</a>
<a href=https://fninit.com/tags/go/>go</a>
<a href=https://fninit.com/tags/golang/>golang</a>
<a href=https://fninit.com/tags/hugo/>hugo</a>
<a href=https://fninit.com/tags/ios/>iOS</a>
<a href=https://fninit.com/tags/kindle/>Kindle</a>
<a href=https://fninit.com/tags/kvocontroller/>KVOController</a>
<a href=https://fninit.com/tags/linux/>linux</a>
<a href=https://fninit.com/tags/macos/>MacOS</a>
<a href=https://fninit.com/tags/neovim/>neovim</a>
<a href=https://fninit.com/tags/runtime/>runtime</a>
<a href=https://fninit.com/tags/rust/>rust</a>
<a href=https://fninit.com/tags/ss/>ss</a>
<a href=https://fninit.com/tags/ssh/>ssh</a>
<a href=https://fninit.com/tags/swift/>Swift</a>
<a href=https://fninit.com/tags/vim/>vim</a>
<a href=https://fninit.com/tags/webhook/>webhook</a>
<a href=https://fninit.com/tags/wubi/>wubi</a>
<a href=https://fninit.com/tags/zabbix/>zabbix</a></div></section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a href></a></li></ul></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=/index.xml><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/roninro><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; RoninRo's Blog 2022<br>Powered by <a href=https://gohugo.io>Hugo</a></p></div></div></div></footer><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js crossorigin=anonymous></script>
<script src=https://fninit.com/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script>
<script src=/js/simple-jekyll-search.min.js></script>
<script src=https://fninit.com/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js></script>
<script></script><script src=/zoomjs/zoom.min.js></script></body></html>