<!DOCTYPE html><html lang="en" class="casper"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>KVO &amp; KVOController | KVO &amp; KVOController</title><meta name="robots" content="index,follow"/><meta name="description" content="Thoughts, stories and ideas."/><meta name="twitter:card" content="summary_large_image"/><meta property="og:title" content="KVO &amp; KVOController | KVO &amp; KVOController"/><meta property="og:description" content="Thoughts, stories and ideas."/><meta property="og:url" content="https://fninit.com/posts/2017/ios-KVOController/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2017-06-30T03:08:26.000Z"/><meta property="article:author" content="Roninro"/><meta property="og:image" content="https://fninit.com/site-meta.png"/><link rel="canonical" href="https://fninit.com/posts/2017/ios-KVOController/"/><link rel="preload" as="image" imageSrcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 16w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 32w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 48w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 64w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 96w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 128w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 256w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 384w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 3840w" imageSizes="
                              (max-width: 350px) 350px,
                              (max-width: 530px) 530px,
                              (max-width: 710px) 710px,
                              (max-width: 1170px) 1170px,
                              (max-width: 2110px) 2110px, 2000px
                            "/><meta name="next-head-count" content="15"/><link rel="alternate" type="application/rss+xml" title="RoninRo&#x27;s Blog RSS Feed" href="https://fninit.com/rss.xml"/><link rel="preload" href="/_next/static/css/4ac02ab48bb2a349.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4ac02ab48bb2a349.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-e75f20a0d9e1f5eb.js" defer=""></script><script src="/_next/static/chunks/main-e6dfde739e3003a9.js" defer=""></script><script src="/_next/static/chunks/pages/_app-26430ffae28b5603.js" defer=""></script><script src="/_next/static/chunks/761-e0ebe2fd26a8af10.js" defer=""></script><script src="/_next/static/chunks/771-7cac59a0a901328d.js" defer=""></script><script src="/_next/static/chunks/747-48db26b6b4742ec5.js" defer=""></script><script src="/_next/static/chunks/501-12f7c6e56e1c082c.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-8b5be30ea1b90f7b.js" defer=""></script><script src="/_next/static/hNIbUDA85B46UOFY91l_c/_buildManifest.js" defer=""></script><script src="/_next/static/hNIbUDA85B46UOFY91l_c/_ssgManifest.js" defer=""></script><script src="/_next/static/hNIbUDA85B46UOFY91l_c/_middlewareManifest.js" defer=""></script></head><body class="post-template tag-kvocontroller tag-ios"><script>
            (function(){
                window.isDark = localStorage.getItem('dark');
                if ( window.isDark === 'dark' ) {
                  document.body.classList.add('dark')
                } else if( window.isDark === undefined && window.matchMedia('(prefers-color-scheme: dark)').matches === true ){
                  document.body.classList.add('dark')
                }
            })()
          </script><div id="__next"><div class="site-wrapper"><header class="site-header"><div class="outer site-nav-main "><div class="inner"><nav class="site-nav"><div class="site-nav-left-wrapper"><div class="site-nav-left"><a class="site-nav-logo" href="/"><div style="height:${targetHeight}px;width:25.925925925925927px"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;padding-top:81%"></span><img alt="RoninRo&#x27;s Blog" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive" class="site-nav-logo" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="RoninRo&#x27;s Blog" sizes="100vw" srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/logo.png" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="site-nav-logo" loading="lazy"/></noscript></span></div></a><div class="site-nav-content"><ul class="nav" role="menu"><li class="nav-home" role="menuitem"><div><a href="/">Home</a></div></li><li class="nav-about" role="menuitem"><div><a href="/about/">About</a></div></li></ul><span class="nav-post-title ">KVO &amp; KVOController</span></div></div></div><div class="site-nav-right"><div class="social-links"></div><button class="social-link social-link-tw" title="DarkMode" style="background-color:transparent"><svg viewBox="0 0 512 512"></svg></button></div></nav></div></div></header><main id="site-main" class="site-main outer "><div class="inner"><article class="post-full post tag-kvocontroller tag-ios featured"><header class="post-full-header"><section class="post-full-tags"><a href="/tag/kvocontroller/">KVOController</a></section><h1 class="post-full-title">KVO &amp; KVOController</h1><div class="post-full-byline"><section class="post-full-byline-content"><ul class="author-list"><li class="author-list-item"><div class="author-card "><div class="author-profile-image"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;padding-top:100%"></span><img alt="Roninro" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive" class="author-profile-image" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Roninro" sizes="100vw" srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="author-profile-image" loading="lazy"/></noscript></span></div><div class="author-info"><div class="bio"><h2>Roninro</h2><p>Software Development Engineer</p><p><a href="/author/roninro/">More posts</a> <!-- -->by<!-- --> <!-- -->Roninro<!-- -->.<!-- --></p></div></div></div><a class="author-avatar" aria-label="Roninro" href="/author/roninro/"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;padding-top:100%"></span><img alt="Roninro" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Roninro" sizes="100vw" srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></a></li></ul><section class="post-full-byline-meta"><h4 class="author-name"><span><a href="/author/roninro/">Roninro</a></span></h4><div class="byline-meta-content"><time class="byline-meta-date" dateTime="2017-06-30T03:08:26.000Z">30 June, 2017<!-- --> <!-- --></time><span class="byline-reading-time"><span class="bull">•</span> <!-- -->8 min read<!-- --></span></div></section></section></div></header><figure class="post-full-image" style="display:inherit"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;padding-top:66.64999999999999%"></span><img alt="KVO &amp; KVOController" sizes="
                              (max-width: 350px) 350px,
                              (max-width: 530px) 530px,
                              (max-width: 710px) 710px,
                              (max-width: 1170px) 1170px,
                              (max-width: 2110px) 2110px, 2000px
                            " srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 16w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 32w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 48w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 64w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 96w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 128w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 256w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 384w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/wOZ0yyfTV5w-unsplash.jpg" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></span></figure><section class="post-full-content"><div class="post-content load-external-scripts"><h3 id="kvo的实现机制"><a aria-hidden="true" tabindex="-1" href="#kvo的实现机制"><span class="icon icon-link"></span></a>KVO的实现机制<!-- --></h3>
<!-- --><p>KVO 是 Objective-C 对观察者模式的实现。从苹果的
<!-- --><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html">文档</a>
中对于它的实现描述可以知道： KVO 是通过 isa-swizzling 实现的。
当你观察一个对象时，该对象的isa指针被修改，指向一个中间类，而不是其真实的类。但是具体的实现苹果的文档里并没有详细说明。<!-- --></p>
<!-- --><p>事实上，这个中间类会在对象被观察时动态地被创建。继承自该对象原来的类，并且重写被观察属性的 setter 方法。重写的方法负责在调用原 setter 方法之前和之后，通知所有观察对象值的更改。然后将 isa 指针指向新创建的类。这样对象就变成了新创建的子类的实例了。</p>
<!-- --><p>参考 Mike Ash 的 <!-- --><a href="https://www.mikeash.com/pyblog/friday-qa-2009-01-23.html">Friday Q&amp;A 2009-01-23</a>。<!-- --></p>
<!-- --><p><a href="https://github.com/mjyi/blogdemos/tree/master/kvo">测试代码地址</a></p>
<!-- --><h3 id="kvo-的缺点"><a aria-hidden="true" tabindex="-1" href="#kvo-的缺点"><span class="icon icon-link"></span></a>KVO 的缺点<!-- --></h3>
<!-- --><p>KVO的缺点在于它的API，我们只能通过
observeValueForKeyPath: ofObject: change: context: 来获得通知。无法通过自定义 selector 或 block 来处理通知事件。因此我们可能需要一些判断来处理不同的情况。</p>
<!-- --><p>在了解了kov的实现机制后，我们可以使用block实现KVO.</p>
<!-- --><p>参考：<!-- --><a href="https://knightsj.github.io/2017/05/15/%E4%BD%BF%E7%94%A8Block%E5%AE%9E%E7%8E%B0KVO/">使用Block实现KVO</a> 、
<!-- --><a href="http://tech.glowing.com/cn/implement-kvo/">如何自己动手实现 KVO</a></p>
<!-- --><h3 id="kvocontroller"><a aria-hidden="true" tabindex="-1" href="#kvocontroller"><span class="icon icon-link"></span></a>KVOController<!-- --></h3>
<!-- --><p><a href="https://github.com/facebook/KVOController">KVOController</a>是Facebook 推出的一个开源库。它是基于 Cocoa 的KVO 的一次封装，提供简单的API，并且是线程安全的。<!-- --></p>
<!-- --><p>使用方法：</p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token comment">// create KVO controller with observer</span>
<!-- --></span><span class="code-line">FBKVOController <!-- --><span class="token operator">*</span>KVOController <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>FBKVOController controllerWithObserver<!-- --><span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token keyword">self</span><span class="token punctuation">.</span>KVOController <!-- --><span class="token operator">=</span> KVOController<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line"><span class="token comment">// observe clock date property</span>
<!-- --></span><span class="code-line"><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>KVOController observe<!-- --><span class="token punctuation">:</span>clock keyPath<!-- --><span class="token punctuation">:</span><span class="token string">@&quot;date&quot;</span> options<!-- --><span class="token punctuation">:</span>NSKeyValueObservingOptionInitial<!-- --><span class="token operator">|</span>NSKeyValueObservingOptionNew block<!-- --><span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>ClockView <!-- --><span class="token operator">*</span>clockView<!-- --><span class="token punctuation">,</span> Clock <!-- --><span class="token operator">*</span>clock<!-- --><span class="token punctuation">,</span> NSDictionary <!-- --><span class="token operator">*</span>change<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token comment">// update clock view with new value</span>
<!-- --></span><span class="code-line">  clockView<!-- --><span class="token punctuation">.</span>date <!-- --><span class="token operator">=</span> change<!-- --><span class="token punctuation">[</span>NSKeyValueChangeNewKey<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span></code></pre>
<!-- --><p>在使用 KVOController时，我们不需要关注在何时移除观察者，因为KVOController会在dealloc时自动将其移除。
使用 block 来处理KVO的通知事件，更是一种美好的体验。</p>
<!-- --><h4 id="项目结构"><a aria-hidden="true" tabindex="-1" href="#项目结构"><span class="icon icon-link"></span></a>项目结构<!-- --></h4>
<!-- --><p>KVOController 整个项目结构只能有5个文件：</p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line">├── KVOController<!-- --><span class="token punctuation">.</span>h
<!-- --></span><span class="code-line">├── FBKVOController<!-- --><span class="token punctuation">.</span>h
<!-- --></span><span class="code-line">├── FBKVOController<!-- --><span class="token punctuation">.</span>m
<!-- --></span><span class="code-line">├── NSObject<!-- --><span class="token operator">+</span>FBKVOController<!-- --><span class="token punctuation">.</span>h
<!-- --></span><span class="code-line">└── NSObject<!-- --><span class="token operator">+</span>FBKVOController<!-- --><span class="token punctuation">.</span>m
<!-- --></span></code></pre>
<!-- --><p>其中，KVOController.h 是头文件，NSObject+FBKVOController 通过 AssociateObject 为 NSObject 提供一个 retain 和 非retain 类型的KVOController。 FBKVOController文件就是主要的技术实现。</p>
<!-- --><p>在 FBKVOController 文件中主要定义了三个类：</p>
<!-- --><ul>
<!-- --><li>_FBKVOInfo</li>
<!-- --><li>_FBKVOSharedController</li>
<!-- --><li>_KVOController</li>
<!-- --></ul>
<!-- --><h4 id="fbkvocontroller"><a aria-hidden="true" tabindex="-1" href="#fbkvocontroller"><span class="icon icon-link"></span></a>FBKVOController<!-- --></h4>
<!-- --><p>成员变量以及初始化方法：</p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token comment">/**
</span></span><span class="code-line"><span class="token comment"> The observer notified on key-value change. Specified on initialization.
</span></span><span class="code-line"><span class="token comment"> */</span>
<!-- --></span><span class="code-line"><span class="token keyword">@property</span> <!-- --><span class="token punctuation">(</span>nullable<!-- --><span class="token punctuation">,</span> nonatomic<!-- --><span class="token punctuation">,</span> weak<!-- --><span class="token punctuation">,</span> readonly<!-- --><span class="token punctuation">)</span> id observer<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token keyword">@implementation</span> FBKVOController
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  NSMapTable<!-- --><span class="token operator">&lt;</span>id<!-- --><span class="token punctuation">,</span> NSMutableSet<!-- --><span class="token operator">&lt;</span>_FBKVOInfo <!-- --><span class="token operator">*</span><span class="token operator">&gt;</span> <!-- --><span class="token operator">*</span><span class="token operator">&gt;</span> <!-- --><span class="token operator">*</span>_objectInfosMap<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  pthread_mutex_t _lock<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">
</span><span class="code-line"><span class="token operator">-</span> <!-- --><span class="token punctuation">(</span>instancetype<!-- --><span class="token punctuation">)</span>initWithObserver<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>nullable id<!-- --><span class="token punctuation">)</span>observer retainObserved<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>BOOL<!-- --><span class="token punctuation">)</span>retainObserved
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">self</span> <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span><span class="token keyword">super</span> init<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">!=</span> <!-- --><span class="token keyword">self</span><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    _observer <!-- --><span class="token operator">=</span> observer<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">    NSPointerFunctionsOptions keyOptions <!-- --><span class="token operator">=</span> retainObserved <!-- --><span class="token operator">?</span> NSPointerFunctionsStrongMemory<!-- --><span class="token operator">|</span>NSPointerFunctionsObjectPointerPersonality <!-- --><span class="token punctuation">:</span> NSPointerFunctionsWeakMemory<!-- --><span class="token operator">|</span>NSPointerFunctionsObjectPointerPersonality<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">    _objectInfosMap <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span><span class="token punctuation">[</span>NSMapTable alloc<!-- --><span class="token punctuation">]</span> initWithKeyOptions<!-- --><span class="token punctuation">:</span>keyOptions valueOptions<!-- --><span class="token punctuation">:</span>NSPointerFunctionsStrongMemory<!-- --><span class="token operator">|</span>NSPointerFunctionsObjectPersonality capacity<!-- --><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<!-- --><span class="token punctuation">,</span> <!-- --><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">return</span> <!-- --><span class="token keyword">self</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><ol>
<!-- --><li>KVOController 维护了一个对观察者的弱引用,在初始化时，传入的observer赋值给_observer进行weak持有。</li>
<!-- --></ol>
<!-- --><ul>
<!-- --><li>NSMapTable, 和NSDictionary 类似，但是是一个object-object的映射关系，并且可以指定 key、value的strong，weak 或者 copy 类型。通过retainObserved参数来生成对应的weak或者strong的NSPointerFunctionsOptions</li>
<!-- --><li>_lock 互斥锁，保证线程安全。</li>
<!-- --></ul>
<!-- --><p>FBKVOController对观察对象 add Observer</p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token operator">-</span> <!-- --><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>observe<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>nullable id<!-- --><span class="token punctuation">)</span>object keyPath<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <!-- --><span class="token operator">*</span><span class="token punctuation">)</span>keyPath options<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>NSKeyValueObservingOptions<!-- --><span class="token punctuation">)</span>options block<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>FBKVONotificationBlock<!-- --><span class="token punctuation">)</span>block
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">NSAssert</span><span class="token punctuation">(</span><span class="token number">0</span> <!-- --><span class="token operator">!=</span> keyPath<!-- --><span class="token punctuation">.</span>length <!-- --><span class="token operator">&amp;&amp;</span> <!-- --><span class="token constant">NULL</span> <!-- --><span class="token operator">!=</span> block<!-- --><span class="token punctuation">,</span> <!-- --><span class="token string">@&quot;missing required parameters observe:%@ keyPath:%@ block:%p&quot;</span><span class="token punctuation">,</span> object<!-- --><span class="token punctuation">,</span> keyPath<!-- --><span class="token punctuation">,</span> block<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">==</span> object <!-- --><span class="token operator">||</span> <!-- --><span class="token number">0</span> <!-- --><span class="token operator">==</span> keyPath<!-- --><span class="token punctuation">.</span>length <!-- --><span class="token operator">||</span> <!-- --><span class="token constant">NULL</span> <!-- --><span class="token operator">==</span> block<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token keyword">return</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// create info</span>
<!-- --></span><span class="code-line">  _FBKVOInfo <!-- --><span class="token operator">*</span>info <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span><span class="token punctuation">[</span>_FBKVOInfo alloc<!-- --><span class="token punctuation">]</span> initWithController<!-- --><span class="token punctuation">:</span><span class="token keyword">self</span> keyPath<!-- --><span class="token punctuation">:</span>keyPath options<!-- --><span class="token punctuation">:</span>options block<!-- --><span class="token punctuation">:</span>block<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// observe object with info</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">[</span><span class="token keyword">self</span> _observe<!-- --><span class="token punctuation">:</span>object info<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">
</span><span class="code-line"><span class="token operator">-</span> <!-- --><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>_observe<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>id<!-- --><span class="token punctuation">)</span>object info<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>_FBKVOInfo <!-- --><span class="token operator">*</span><span class="token punctuation">)</span>info
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token comment">// lock</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  NSMutableSet <!-- --><span class="token operator">*</span>infos <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>_objectInfosMap objectForKey<!-- --><span class="token punctuation">:</span>object<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// check for info existence</span>
<!-- --></span><span class="code-line">  _FBKVOInfo <!-- --><span class="token operator">*</span>existingInfo <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>infos member<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">!=</span> existingInfo<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token comment">// observation info already exists; do not observe it again</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">    <!-- --><span class="token comment">// unlock and return</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token keyword">return</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// lazilly create set of infos</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">==</span> infos<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    infos <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>NSMutableSet set<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token punctuation">[</span>_objectInfosMap setObject<!-- --><span class="token punctuation">:</span>infos forKey<!-- --><span class="token punctuation">:</span>object<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// add info and oberve</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">[</span>infos addObject<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// unlock prior to callout</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token punctuation">[</span><span class="token punctuation">[</span>_FBKVOSharedController sharedController<!-- --><span class="token punctuation">]</span> observe<!-- --><span class="token punctuation">:</span>object info<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><p>代码中对于实现思路做了很好的注释：</p>
<!-- --><ol>
<!-- --><li>首先对于传入的操作进行断言判断。</li>
<!-- --></ol>
<!-- --><ul>
<!-- --><li>使用传入参数创建 _FBKVOInfo 实例 info。对info 添加观察[self _observe:object info:info];。</li>
<!-- --><li>对_objectInfosMap 进行检查，避免重复添加。并在读写时使用加锁，保证线程安全。</li>
<!-- --><li>添加成功后调用 [[_FBKVOSharedController sharedController] observe:object info:info]</li>
<!-- --></ul>
<!-- --><p>实现隐式地移除KVO：</p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token operator">-</span> <!-- --><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>dealloc
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">[</span><span class="token keyword">self</span> unobserveAll<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span><span class="code-line"><span class="token operator">-</span> <!-- --><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>_unobserveAll
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token comment">// lock</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  NSMapTable <!-- --><span class="token operator">*</span>objectInfoMaps <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>_objectInfosMap copy<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// clear table and map</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">[</span>_objectInfosMap removeAllObjects<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// unlock</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  _FBKVOSharedController <!-- --><span class="token operator">*</span>shareController <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>_FBKVOSharedController sharedController<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token keyword">for</span> <!-- --><span class="token punctuation">(</span>id object <!-- --><span class="token keyword">in</span> objectInfoMaps<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token comment">// unobserve each registered object and infos</span>
<!-- --></span><span class="code-line">    NSSet <!-- --><span class="token operator">*</span>infos <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>objectInfoMaps objectForKey<!-- --><span class="token punctuation">:</span>object<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token punctuation">[</span>shareController unobserve<!-- --><span class="token punctuation">:</span>object infos<!-- --><span class="token punctuation">:</span>infos<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><p>在 KVOController 释放的时候，从_FBKVOSharedController单例中移除 observer</p>
<!-- --><h4 id="_fbkvosharedcontroller"><a aria-hidden="true" tabindex="-1" href="#_fbkvosharedcontroller"><span class="icon icon-link"></span></a>_FBKVOSharedController<!-- --></h4>
<!-- --><p>_FBKVOSharedController 被设计成单例，统一管理KVO通知的接收和转发。</p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token keyword">@implementation</span> _FBKVOSharedController
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  NSHashTable<!-- --><span class="token operator">&lt;</span>_FBKVOInfo <!-- --><span class="token operator">*</span><span class="token operator">&gt;</span> <!-- --><span class="token operator">*</span>_infos<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  pthread_mutex_t _mutex<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><ul>
<!-- --><li>_infos:  NSHashTable类型，类似NSSet，同样也可以设置对象的强弱引用。</li>
<!-- --><li>_mutex： 互斥锁，为了线程安全。</li>
<!-- --></ul>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token operator">-</span> <!-- --><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>observe<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>id<!-- --><span class="token punctuation">)</span>object info<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>nullable _FBKVOInfo <!-- --><span class="token operator">*</span><span class="token punctuation">)</span>info
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">==</span> info<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token keyword">return</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// register info</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutex<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">[</span>_infos addObject<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutex<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// add observer</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">[</span>object addObserver<!-- --><span class="token punctuation">:</span><span class="token keyword">self</span> forKeyPath<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token operator">-&gt;</span>_keyPath options<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token operator">-&gt;</span>_options context<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <!-- --><span class="token operator">*</span><span class="token punctuation">)</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>info<!-- --><span class="token operator">-&gt;</span>_state <!-- --><span class="token operator">==</span> _FBKVOInfoStateInitial<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    info<!-- --><span class="token operator">-&gt;</span>_state <!-- --><span class="token operator">=</span> _FBKVOInfoStateObserving<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span> <!-- --><span class="token keyword">else</span> <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>info<!-- --><span class="token operator">-&gt;</span>_state <!-- --><span class="token operator">==</span> _FBKVOInfoStateNotObserving<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token punctuation">[</span>object removeObserver<!-- --><span class="token punctuation">:</span><span class="token keyword">self</span> forKeyPath<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token operator">-&gt;</span>_keyPath context<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <!-- --><span class="token operator">*</span><span class="token punctuation">)</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><ul>
<!-- --><li>将 info 加入 _infos.</li>
<!-- --><li>[object addObserver:self forKeyPath:info-&gt;_keyPath options:info-&gt;_options context:(void *)info] 为object 添加观察者。</li>
<!-- --></ul>
<!-- --><p>在 _FBKVOSharedController 实现observeValueForKeyPath:ofObject:Change:context 接收处理通知。</p>
<!-- --><p><strong>info = [_infos member:(__bridge id)context];</strong>
在 _infos 中找到当前 _FBKVOInfo,并对它进行一个强引用。对数据进行封装，执行注册的回调。block， selector, 默认方法。<!-- --></p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">!=</span> info<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token comment">// take strong reference to controller</span>
<!-- --></span><span class="code-line">    FBKVOController <!-- --><span class="token operator">*</span>controller <!-- --><span class="token operator">=</span> info<!-- --><span class="token operator">-&gt;</span>_controller<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">!=</span> controller<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">      <!-- --><span class="token comment">// take strong reference to observer</span>
<!-- --></span><span class="code-line">      id observer <!-- --><span class="token operator">=</span> controller<!-- --><span class="token punctuation">.</span>observer<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">      <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">!=</span> observer<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">        <!-- --><span class="token comment">// dispatch custom block or action, fall back to default action</span>
<!-- --></span><span class="code-line">        <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>info<!-- --><span class="token operator">-&gt;</span>_block<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">          NSDictionary<!-- --><span class="token operator">&lt;</span>NSKeyValueChangeKey<!-- --><span class="token punctuation">,</span> id<!-- --><span class="token operator">&gt;</span> <!-- --><span class="token operator">*</span>changeWithKeyPath <!-- --><span class="token operator">=</span> change<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">          <!-- --><span class="token comment">// add the keyPath to the change dictionary for clarity when mulitple keyPaths are being observed</span>
<!-- --></span><span class="code-line">          <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>keyPath<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">            NSMutableDictionary<!-- --><span class="token operator">&lt;</span>NSString <!-- --><span class="token operator">*</span><span class="token punctuation">,</span> id<!-- --><span class="token operator">&gt;</span> <!-- --><span class="token operator">*</span>mChange <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>NSMutableDictionary dictionaryWithObject<!-- --><span class="token punctuation">:</span>keyPath forKey<!-- --><span class="token punctuation">:</span>FBKVONotificationKeyPathKey<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">            <!-- --><span class="token punctuation">[</span>mChange addEntriesFromDictionary<!-- --><span class="token punctuation">:</span>change<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">            changeWithKeyPath <!-- --><span class="token operator">=</span> <!-- --><span class="token punctuation">[</span>mChange copy<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">          <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">          info<!-- --><span class="token operator">-&gt;</span><span class="token function">_block</span><span class="token punctuation">(</span>observer<!-- --><span class="token punctuation">,</span> object<!-- --><span class="token punctuation">,</span> changeWithKeyPath<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">        <!-- --><span class="token punctuation">}</span> <!-- --><span class="token keyword">else</span> <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>info<!-- --><span class="token operator">-&gt;</span>_action<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <!-- --><span class="token expression">clang diagnostic push</span></span>
<!-- --></span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <!-- --><span class="token expression">clang diagnostic ignored </span><span class="token string">&quot;-Warc-performSelector-leaks&quot;</span></span>
<!-- --></span><span class="code-line">          <!-- --><span class="token punctuation">[</span>observer performSelector<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token operator">-&gt;</span>_action withObject<!-- --><span class="token punctuation">:</span>change withObject<!-- --><span class="token punctuation">:</span>object<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <!-- --><span class="token expression">clang diagnostic pop</span></span>
<!-- --></span><span class="code-line">        <!-- --><span class="token punctuation">}</span> <!-- --><span class="token keyword">else</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">          <!-- --><span class="token punctuation">[</span>observer observeValueForKeyPath<!-- --><span class="token punctuation">:</span>keyPath ofObject<!-- --><span class="token punctuation">:</span>object change<!-- --><span class="token punctuation">:</span>change context<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token operator">-&gt;</span>_context<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">        <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">      <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><p><strong>unobserve</strong> ,在KVOController <!-- --><em>dealloc()</em> 时会将 info 从 _infos中移除，并用移除观察者 ，从而实现隐式地移除KVO。<!-- --></p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token operator">-</span> <!-- --><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>unobserve<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>id<!-- --><span class="token punctuation">)</span>object info<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span>nullable _FBKVOInfo <!-- --><span class="token operator">*</span><span class="token punctuation">)</span>info
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>nil <!-- --><span class="token operator">==</span> info<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token keyword">return</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// unregister info</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutex<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">[</span>_infos removeObject<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutex<!-- --><span class="token punctuation">)</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">
</span><span class="code-line">  <!-- --><span class="token comment">// remove observer</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">if</span> <!-- --><span class="token punctuation">(</span>info<!-- --><span class="token operator">-&gt;</span>_state <!-- --><span class="token operator">==</span> _FBKVOInfoStateObserving<!-- --><span class="token punctuation">)</span> <!-- --><span class="token punctuation">{</span>
<!-- --></span><span class="code-line">    <!-- --><span class="token punctuation">[</span>object removeObserver<!-- --><span class="token punctuation">:</span><span class="token keyword">self</span> forKeyPath<!-- --><span class="token punctuation">:</span>info<!-- --><span class="token operator">-&gt;</span>_keyPath context<!-- --><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <!-- --><span class="token operator">*</span><span class="token punctuation">)</span>info<!-- --><span class="token punctuation">]</span><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token punctuation">}</span>
<!-- --></span><span class="code-line">  info<!-- --><span class="token operator">-&gt;</span>_state <!-- --><span class="token operator">=</span> _FBKVOInfoStateNotObserving<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><h4 id="_fbkvoinfo"><a aria-hidden="true" tabindex="-1" href="#_fbkvoinfo"><span class="icon icon-link"></span></a>_FBKVOInfo<!-- --></h4>
<!-- --><p>_FBKVOInfo 将 将观察者信息保存在一起，并且重写了 hash 和 isEqual，以 _keyPath作为唯一性判断依据。</p>
<!-- --><pre class="language-objectivec"><code class="language-objectivec code-highlight"><span class="code-line"><span class="token keyword">@implementation</span> _FBKVOInfo
<!-- --></span><span class="code-line"><span class="token punctuation">{</span>
<!-- --></span><span class="code-line"><span class="token keyword">@public</span>
<!-- --></span><span class="code-line">  __weak FBKVOController <!-- --><span class="token operator">*</span>_controller<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  NSString <!-- --><span class="token operator">*</span>_keyPath<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  NSKeyValueObservingOptions _options<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  SEL _action<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  <!-- --><span class="token keyword">void</span> <!-- --><span class="token operator">*</span>_context<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  FBKVONotificationBlock _block<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line">  _FBKVOInfoState _state<!-- --><span class="token punctuation">;</span>
<!-- --></span><span class="code-line"><span class="token punctuation">}</span>
<!-- --></span></code></pre>
<!-- --><h3 id="reference"><a aria-hidden="true" tabindex="-1" href="#reference"><span class="icon icon-link"></span></a>Reference<!-- --></h3>
<!-- --><ul>
<!-- --><li><a href="https://github.com/facebook/KVOController">KVOController</a></li>
<!-- --><li><a href="http://draveness.me/kvocontroller.html">如何优雅地使用KVO</a></li>
<!-- --></ul>
<!-- --><p>[EOF]</p></div></section><section class="post-full-content"><div class="post-full-comments"><div class="giscus" id="comments-container"></div></div></section></article></div></main><aside class="read-next outer"><div class="inner"><div class="read-next-feed"><article class="post-card post tag-linux tag-vim "><a class="post-card-image-link" aria-label="关于Vim不能正常显示中文的解决方法" href="/posts/2017/linux-vimrc/"><div class="post-card-image"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:absolute;top:0;left:0;bottom:0;right:0"><img alt="关于Vim不能正常显示中文的解决方法" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover"/><noscript><img alt="关于Vim不能正常显示中文的解决方法" sizes="100vw" srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/altumcode-unsplash.webp" decoding="async" data-nimg="fill" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a><div class="post-card-content"><a class="post-card-content-link" href="/posts/2017/linux-vimrc/"><header class="post-card-header"><div class="post-card-primary-tag">linux</div><h2 class="post-card-title">关于Vim不能正常显示中文的解决方法</h2></header><section class="post-card-excerpt"><p></p></section></a><footer class="post-card-meta"><ul class="author-list"><li class="author-list-item"><div class="author-name-tooltip">Roninro</div><a class="static-avatar" aria-label="Roninro" href="/author/roninro/"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;padding-top:100%"></span><img alt="Roninro" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Roninro" sizes="100vw" srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></a></li></ul><div class="post-card-byline-content"><span><span><a href="/author/roninro/">Roninro</a></span></span><span class="post-card-byline-date"><time dateTime="2017-07-10T02:04:03.000Z">10 Jul 2017<!-- --> <!-- --></time><span class="bull">• </span> <!-- -->1 min read<!-- --></span></div></footer></div></article><article class="post-card post tag-ios "><a class="post-card-image-link" aria-label="Carthage 的简单使用" href="/posts/2017/ios-carthage/"><div class="post-card-image"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:absolute;top:0;left:0;bottom:0;right:0"><img alt="Carthage 的简单使用" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="fill" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover"/><noscript><img alt="Carthage 的简单使用" sizes="100vw" srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/dNjMqj4emkc-unsplash.jpg" decoding="async" data-nimg="fill" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover" loading="lazy"/></noscript></span></div></a><div class="post-card-content"><a class="post-card-content-link" href="/posts/2017/ios-carthage/"><header class="post-card-header"><div class="post-card-primary-tag">iOS</div><h2 class="post-card-title">Carthage 的简单使用</h2></header><section class="post-card-excerpt"><p></p></section></a><footer class="post-card-meta"><ul class="author-list"><li class="author-list-item"><div class="author-name-tooltip">Roninro</div><a class="static-avatar" aria-label="Roninro" href="/author/roninro/"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;padding-top:100%"></span><img alt="Roninro" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Roninro" sizes="100vw" srcSet="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 640w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 750w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 828w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1080w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1200w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 1920w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 2048w, https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg 3840w" src="https://cdn.jsdelivr.net/gh/roninro/roninro.github.io@main/images/avatar.jpg" decoding="async" data-nimg="responsive" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></a></li></ul><div class="post-card-byline-content"><span><span><a href="/author/roninro/">Roninro</a></span></span><span class="post-card-byline-date"><time dateTime="2017-06-19T12:57:37.000Z">19 Jun 2017<!-- --> <!-- --></time><span class="bull">• </span> <!-- -->2 min read<!-- --></span></div></footer></div></article></div></div></aside><footer class="site-footer outer"><div class="site-footer-content inner"><section class="copyright"><a href="https://fninit.com/">RoninRo&#x27;s Blog</a> © <!-- -->2022<!-- --></section><nav class="site-footer-nav"><a href="/">Latest Posts</a><a href="https://fninit.com" target="_blank" rel="noopener noreferrer">Roninro</a></nav></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"cmsData":{"settings":{"darkMode":{"defaultMode":"light","overrideOS":true},"nextImages":{"feature":true,"inline":true,"quality":80,"source":false},"rssFeed":true,"toc":{"enable":true,"maxDepth":2},"commenting":{"system":"giscus","disqusShortname":"","giscusConfig":{"repo":"roninro/blog","repoId":"MDEwOlJlcG9zaXRvcnkzMDkyNTUzODI","category":"Comments","categoryId":"DIC_kwDOEm7c1s4B_sst","mapping":"pathname","emitMetadata":false,"reactionsEnabled":true}},"siteUrl":"https://fninit.com","title":"RoninRo's Blog","description":"Thoughts, stories and ideas.","logo":"/images/logo.png","cover_image":"","facebook":"","twitter":"","lang":"en","navigation":[{"label":"Home","url":"/"},{"label":"About","url":"/about/"}],"secondary_navigation":[],"logoImage":{"url":"/images/logo.png","dimensions":{"width":500,"height":405}}},"post":{"slug":"/posts/2017/ios-KVOController","title":"KVO \u0026 KVOController","date":"2017-06-30T03:08:26.000Z","excerpt":null,"draft":false,"page":false,"comment":true,"featureImage":{"url":"/images/wOZ0yyfTV5w-unsplash.jpg","dimensions":{"width":2000,"height":1333}},"toc":null,"tags":[{"name":"KVOController","slug":"kvocontroller","count":1},{"name":"iOS","slug":"ios"}],"authors":[{"slug":"roninro","name":"Roninro","cover_image":"/images/publication-cover.png","profileImage":{"url":"/images/avatar.jpg","dimensions":{"width":1080,"height":1080}},"location":"THE INTERNET","bio":"Software Development Engineer","twitter":"@xxxxx","facebook":"xxxxxx"}],"primary_tag":{"name":"KVOController","slug":"kvocontroller","count":1},"reading_time":"8 min read","mdxSource":"var Component=(()=\u003e{var d=Object.create;var o=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var t=a=\u003eo(a,\"__esModule\",{value:!0});var k=(a,s)=\u003e()=\u003e(s||a((s={exports:{}}).exports,s),s.exports),b=(a,s)=\u003e{for(var c in s)o(a,c,{get:s[c],enumerable:!0})},i=(a,s,c,e)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let l of m(s))!N.call(a,l)\u0026\u0026(c||l!==\"default\")\u0026\u0026o(a,l,{get:()=\u003es[l],enumerable:!(e=h(s,l))||e.enumerable});return a},f=(a,s)=\u003ei(t(o(a!=null?d(u(a)):{},\"default\",!s\u0026\u0026a\u0026\u0026a.__esModule?{get:()=\u003ea.default,enumerable:!0}:{value:a,enumerable:!0})),a),g=(a=\u003e(s,c)=\u003ea\u0026\u0026a.get(s)||(c=i(t({}),s,1),a\u0026\u0026a.set(s,c),c))(typeof WeakMap!=\"undefined\"?new WeakMap:0);var p=k((V,r)=\u003e{r.exports=_jsx_runtime});var v={};b(v,{default:()=\u003e_,frontmatter:()=\u003eO});var n=f(p()),O={categories:[\"iOS\"],date:\"2017-06-30T11:08:26+08:00\",tags:[\"KVOController\",\"iOS\"],title:\"KVO \u0026 KVOController\",authors:[\"Roninro\"],feature_image:\"/images/wOZ0yyfTV5w-unsplash.jpg\"};function y(a={}){let{wrapper:s}=a.components||{};return s?(0,n.jsx)(s,Object.assign({},a,{children:(0,n.jsx)(c,{})})):c();function c(){let e=Object.assign({h3:\"h3\",a:\"a\",span:\"span\",p:\"p\",pre:\"pre\",code:\"code\",h4:\"h4\",ul:\"ul\",li:\"li\",ol:\"ol\",strong:\"strong\",em:\"em\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h3,{id:\"kvo\\u7684\\u5B9E\\u73B0\\u673A\\u5236\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#kvo\\u7684\\u5B9E\\u73B0\\u673A\\u5236\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"KVO\\u7684\\u5B9E\\u73B0\\u673A\\u5236\"]}),`\n`,(0,n.jsxs)(e.p,{children:[`KVO \\u662F Objective-C \\u5BF9\\u89C2\\u5BDF\\u8005\\u6A21\\u5F0F\\u7684\\u5B9E\\u73B0\\u3002\\u4ECE\\u82F9\\u679C\\u7684\n`,(0,n.jsx)(e.a,{href:\"https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html\",children:\"\\u6587\\u6863\"}),`\n\\u4E2D\\u5BF9\\u4E8E\\u5B83\\u7684\\u5B9E\\u73B0\\u63CF\\u8FF0\\u53EF\\u4EE5\\u77E5\\u9053\\uFF1A KVO \\u662F\\u901A\\u8FC7 isa-swizzling \\u5B9E\\u73B0\\u7684\\u3002\n\\u5F53\\u4F60\\u89C2\\u5BDF\\u4E00\\u4E2A\\u5BF9\\u8C61\\u65F6\\uFF0C\\u8BE5\\u5BF9\\u8C61\\u7684isa\\u6307\\u9488\\u88AB\\u4FEE\\u6539\\uFF0C\\u6307\\u5411\\u4E00\\u4E2A\\u4E2D\\u95F4\\u7C7B\\uFF0C\\u800C\\u4E0D\\u662F\\u5176\\u771F\\u5B9E\\u7684\\u7C7B\\u3002\\u4F46\\u662F\\u5177\\u4F53\\u7684\\u5B9E\\u73B0\\u82F9\\u679C\\u7684\\u6587\\u6863\\u91CC\\u5E76\\u6CA1\\u6709\\u8BE6\\u7EC6\\u8BF4\\u660E\\u3002`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u4E8B\\u5B9E\\u4E0A\\uFF0C\\u8FD9\\u4E2A\\u4E2D\\u95F4\\u7C7B\\u4F1A\\u5728\\u5BF9\\u8C61\\u88AB\\u89C2\\u5BDF\\u65F6\\u52A8\\u6001\\u5730\\u88AB\\u521B\\u5EFA\\u3002\\u7EE7\\u627F\\u81EA\\u8BE5\\u5BF9\\u8C61\\u539F\\u6765\\u7684\\u7C7B\\uFF0C\\u5E76\\u4E14\\u91CD\\u5199\\u88AB\\u89C2\\u5BDF\\u5C5E\\u6027\\u7684 setter \\u65B9\\u6CD5\\u3002\\u91CD\\u5199\\u7684\\u65B9\\u6CD5\\u8D1F\\u8D23\\u5728\\u8C03\\u7528\\u539F setter \\u65B9\\u6CD5\\u4E4B\\u524D\\u548C\\u4E4B\\u540E\\uFF0C\\u901A\\u77E5\\u6240\\u6709\\u89C2\\u5BDF\\u5BF9\\u8C61\\u503C\\u7684\\u66F4\\u6539\\u3002\\u7136\\u540E\\u5C06 isa \\u6307\\u9488\\u6307\\u5411\\u65B0\\u521B\\u5EFA\\u7684\\u7C7B\\u3002\\u8FD9\\u6837\\u5BF9\\u8C61\\u5C31\\u53D8\\u6210\\u4E86\\u65B0\\u521B\\u5EFA\\u7684\\u5B50\\u7C7B\\u7684\\u5B9E\\u4F8B\\u4E86\\u3002\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u53C2\\u8003 Mike Ash \\u7684 \",(0,n.jsx)(e.a,{href:\"https://www.mikeash.com/pyblog/friday-qa-2009-01-23.html\",children:\"Friday Q\u0026A 2009-01-23\"}),\"\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:(0,n.jsx)(e.a,{href:\"https://github.com/mjyi/blogdemos/tree/master/kvo\",children:\"\\u6D4B\\u8BD5\\u4EE3\\u7801\\u5730\\u5740\"})}),`\n`,(0,n.jsxs)(e.h3,{id:\"kvo-\\u7684\\u7F3A\\u70B9\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#kvo-\\u7684\\u7F3A\\u70B9\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"KVO \\u7684\\u7F3A\\u70B9\"]}),`\n`,(0,n.jsx)(e.p,{children:`KVO\\u7684\\u7F3A\\u70B9\\u5728\\u4E8E\\u5B83\\u7684API\\uFF0C\\u6211\\u4EEC\\u53EA\\u80FD\\u901A\\u8FC7\nobserveValueForKeyPath: ofObject: change: context: \\u6765\\u83B7\\u5F97\\u901A\\u77E5\\u3002\\u65E0\\u6CD5\\u901A\\u8FC7\\u81EA\\u5B9A\\u4E49 selector \\u6216 block \\u6765\\u5904\\u7406\\u901A\\u77E5\\u4E8B\\u4EF6\\u3002\\u56E0\\u6B64\\u6211\\u4EEC\\u53EF\\u80FD\\u9700\\u8981\\u4E00\\u4E9B\\u5224\\u65AD\\u6765\\u5904\\u7406\\u4E0D\\u540C\\u7684\\u60C5\\u51B5\\u3002`}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5728\\u4E86\\u89E3\\u4E86kov\\u7684\\u5B9E\\u73B0\\u673A\\u5236\\u540E\\uFF0C\\u6211\\u4EEC\\u53EF\\u4EE5\\u4F7F\\u7528block\\u5B9E\\u73B0KVO.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u53C2\\u8003\\uFF1A\",(0,n.jsx)(e.a,{href:\"https://knightsj.github.io/2017/05/15/%E4%BD%BF%E7%94%A8Block%E5%AE%9E%E7%8E%B0KVO/\",children:\"\\u4F7F\\u7528Block\\u5B9E\\u73B0KVO\"}),` \\u3001\n`,(0,n.jsx)(e.a,{href:\"http://tech.glowing.com/cn/implement-kvo/\",children:\"\\u5982\\u4F55\\u81EA\\u5DF1\\u52A8\\u624B\\u5B9E\\u73B0 KVO\"})]}),`\n`,(0,n.jsxs)(e.h3,{id:\"kvocontroller\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#kvocontroller\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"KVOController\"]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.a,{href:\"https://github.com/facebook/KVOController\",children:\"KVOController\"}),\"\\u662FFacebook \\u63A8\\u51FA\\u7684\\u4E00\\u4E2A\\u5F00\\u6E90\\u5E93\\u3002\\u5B83\\u662F\\u57FA\\u4E8E Cocoa \\u7684KVO \\u7684\\u4E00\\u6B21\\u5C01\\u88C5\\uFF0C\\u63D0\\u4F9B\\u7B80\\u5355\\u7684API\\uFF0C\\u5E76\\u4E14\\u662F\\u7EBF\\u7A0B\\u5B89\\u5168\\u7684\\u3002\"]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u4F7F\\u7528\\u65B9\\u6CD5\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// create KVO controller with observer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"FBKVOController \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"KVOController \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"FBKVOController controllerWithObserver\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"KVOController \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" KVOController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// observe clock date property\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"KVOController observe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"clock keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'@\"date\"'}),\" options\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"NSKeyValueObservingOptionInitial\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\"NSKeyValueObservingOptionNew block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"^\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"ClockView \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"clockView\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" Clock \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"clock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" NSDictionary \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"change\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// update clock view with new value\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  clockView\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"date \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" change\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"NSKeyValueChangeNewKey\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:`\\u5728\\u4F7F\\u7528 KVOController\\u65F6\\uFF0C\\u6211\\u4EEC\\u4E0D\\u9700\\u8981\\u5173\\u6CE8\\u5728\\u4F55\\u65F6\\u79FB\\u9664\\u89C2\\u5BDF\\u8005\\uFF0C\\u56E0\\u4E3AKVOController\\u4F1A\\u5728dealloc\\u65F6\\u81EA\\u52A8\\u5C06\\u5176\\u79FB\\u9664\\u3002\n\\u4F7F\\u7528 block \\u6765\\u5904\\u7406KVO\\u7684\\u901A\\u77E5\\u4E8B\\u4EF6\\uFF0C\\u66F4\\u662F\\u4E00\\u79CD\\u7F8E\\u597D\\u7684\\u4F53\\u9A8C\\u3002`}),`\n`,(0,n.jsxs)(e.h4,{id:\"\\u9879\\u76EE\\u7ED3\\u6784\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#\\u9879\\u76EE\\u7ED3\\u6784\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"\\u9879\\u76EE\\u7ED3\\u6784\"]}),`\n`,(0,n.jsx)(e.p,{children:\"KVOController \\u6574\\u4E2A\\u9879\\u76EE\\u7ED3\\u6784\\u53EA\\u80FD\\u67095\\u4E2A\\u6587\\u4EF6\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\\u251C\\u2500\\u2500 KVOController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`h\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\\u251C\\u2500\\u2500 FBKVOController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`h\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\\u251C\\u2500\\u2500 FBKVOController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`m\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\\u251C\\u2500\\u2500 NSObject\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"FBKVOController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`h\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"\\u2514\\u2500\\u2500 NSObject\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"+\"}),\"FBKVOController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),`m\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5176\\u4E2D\\uFF0CKVOController.h \\u662F\\u5934\\u6587\\u4EF6\\uFF0CNSObject+FBKVOController \\u901A\\u8FC7 AssociateObject \\u4E3A NSObject \\u63D0\\u4F9B\\u4E00\\u4E2A retain \\u548C \\u975Eretain \\u7C7B\\u578B\\u7684KVOController\\u3002 FBKVOController\\u6587\\u4EF6\\u5C31\\u662F\\u4E3B\\u8981\\u7684\\u6280\\u672F\\u5B9E\\u73B0\\u3002\"}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5728 FBKVOController \\u6587\\u4EF6\\u4E2D\\u4E3B\\u8981\\u5B9A\\u4E49\\u4E86\\u4E09\\u4E2A\\u7C7B\\uFF1A\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"_FBKVOInfo\"}),`\n`,(0,n.jsx)(e.li,{children:\"_FBKVOSharedController\"}),`\n`,(0,n.jsx)(e.li,{children:\"_KVOController\"}),`\n`]}),`\n`,(0,n.jsxs)(e.h4,{id:\"fbkvocontroller\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#fbkvocontroller\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"FBKVOController\"]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u6210\\u5458\\u53D8\\u91CF\\u4EE5\\u53CA\\u521D\\u59CB\\u5316\\u65B9\\u6CD5\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:`/**\n`})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token comment\",children:` The observer notified on key-value change. Specified on initialization.\n`})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\" */\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"@property\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nullable\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" nonatomic\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" weak\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" readonly\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" id observer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"@implementation\"}),` FBKVOController\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  NSMapTable\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\"id\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" NSMutableSet\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\"_FBKVOInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_objectInfosMap\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  pthread_mutex_t _lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"instancetype\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"initWithObserver\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nullable id\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"observer retainObserved\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"BOOL\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`retainObserved\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"super\"}),\" init\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    _observer \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" observer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    NSPointerFunctionsOptions keyOptions \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" retainObserved \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"?\"}),\" NSPointerFunctionsStrongMemory\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\"NSPointerFunctionsObjectPointerPersonality \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" NSPointerFunctionsWeakMemory\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\"NSPointerFunctionsObjectPointerPersonality\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    _objectInfosMap \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"NSMapTable alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" initWithKeyOptions\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"keyOptions valueOptions\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"NSPointerFunctionsStrongMemory\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"|\"}),\"NSPointerFunctionsObjectPersonality capacity\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_init\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"KVOController \\u7EF4\\u62A4\\u4E86\\u4E00\\u4E2A\\u5BF9\\u89C2\\u5BDF\\u8005\\u7684\\u5F31\\u5F15\\u7528,\\u5728\\u521D\\u59CB\\u5316\\u65F6\\uFF0C\\u4F20\\u5165\\u7684observer\\u8D4B\\u503C\\u7ED9_observer\\u8FDB\\u884Cweak\\u6301\\u6709\\u3002\"}),`\n`]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"NSMapTable, \\u548CNSDictionary \\u7C7B\\u4F3C\\uFF0C\\u4F46\\u662F\\u662F\\u4E00\\u4E2Aobject-object\\u7684\\u6620\\u5C04\\u5173\\u7CFB\\uFF0C\\u5E76\\u4E14\\u53EF\\u4EE5\\u6307\\u5B9A key\\u3001value\\u7684strong\\uFF0Cweak \\u6216\\u8005 copy \\u7C7B\\u578B\\u3002\\u901A\\u8FC7retainObserved\\u53C2\\u6570\\u6765\\u751F\\u6210\\u5BF9\\u5E94\\u7684weak\\u6216\\u8005strong\\u7684NSPointerFunctionsOptions\"}),`\n`,(0,n.jsx)(e.li,{children:\"_lock \\u4E92\\u65A5\\u9501\\uFF0C\\u4FDD\\u8BC1\\u7EBF\\u7A0B\\u5B89\\u5168\\u3002\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"FBKVOController\\u5BF9\\u89C2\\u5BDF\\u5BF9\\u8C61 add Observer\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"observe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nullable id\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"object keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"NSString \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"keyPath options\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"NSKeyValueObservingOptions\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"options block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"FBKVONotificationBlock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`block\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"NSAssert\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"length \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\u0026\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'@\"missing required parameters observe:%@ keyPath:%@ block:%p\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" object\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" object \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"||\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"0\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"length \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"||\"}),\" \",(0,n.jsx)(e.span,{className:\"token constant\",children:\"NULL\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// create info\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _FBKVOInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"info \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_FBKVOInfo alloc\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" initWithController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),\" keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"keyPath options\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"options block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// observe object with info\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),\" _observe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"_observe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"id\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"object info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"_FBKVOInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`info\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// lock\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_lock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  NSMutableSet \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"infos \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_objectInfosMap objectForKey\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// check for info existence\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _FBKVOInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"existingInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"infos member\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" existingInfo\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// observation info already exists; do not observe it again\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// unlock and return\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_unlock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// lazilly create set of infos\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" infos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    infos \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"NSMutableSet set\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_objectInfosMap setObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"infos forKey\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// add info and oberve\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"infos addObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// unlock prior to callout\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_unlock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_FBKVOSharedController sharedController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" observe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u4EE3\\u7801\\u4E2D\\u5BF9\\u4E8E\\u5B9E\\u73B0\\u601D\\u8DEF\\u505A\\u4E86\\u5F88\\u597D\\u7684\\u6CE8\\u91CA\\uFF1A\"}),`\n`,(0,n.jsxs)(e.ol,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u9996\\u5148\\u5BF9\\u4E8E\\u4F20\\u5165\\u7684\\u64CD\\u4F5C\\u8FDB\\u884C\\u65AD\\u8A00\\u5224\\u65AD\\u3002\"}),`\n`]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u4F7F\\u7528\\u4F20\\u5165\\u53C2\\u6570\\u521B\\u5EFA _FBKVOInfo \\u5B9E\\u4F8B info\\u3002\\u5BF9info \\u6DFB\\u52A0\\u89C2\\u5BDF[self _observe:object info:info];\\u3002\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u5BF9_objectInfosMap \\u8FDB\\u884C\\u68C0\\u67E5\\uFF0C\\u907F\\u514D\\u91CD\\u590D\\u6DFB\\u52A0\\u3002\\u5E76\\u5728\\u8BFB\\u5199\\u65F6\\u4F7F\\u7528\\u52A0\\u9501\\uFF0C\\u4FDD\\u8BC1\\u7EBF\\u7A0B\\u5B89\\u5168\\u3002\"}),`\n`,(0,n.jsx)(e.li,{children:\"\\u6DFB\\u52A0\\u6210\\u529F\\u540E\\u8C03\\u7528 [[_FBKVOSharedController sharedController] observe:object info:info]\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5B9E\\u73B0\\u9690\\u5F0F\\u5730\\u79FB\\u9664KVO\\uFF1A\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`dealloc\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),\" unobserveAll\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_destroy\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`_unobserveAll\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// lock\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_lock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  NSMapTable \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"objectInfoMaps \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_objectInfosMap copy\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// clear table and map\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_objectInfosMap removeAllObjects\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// unlock\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_unlock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_lock\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _FBKVOSharedController \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"shareController \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_FBKVOSharedController sharedController\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"id object \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"in\"}),\" objectInfoMaps\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// unobserve each registered object and infos\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    NSSet \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"infos \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"objectInfoMaps objectForKey\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"shareController unobserve\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object infos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"infos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5728 KVOController \\u91CA\\u653E\\u7684\\u65F6\\u5019\\uFF0C\\u4ECE_FBKVOSharedController\\u5355\\u4F8B\\u4E2D\\u79FB\\u9664 observer\"}),`\n`,(0,n.jsxs)(e.h4,{id:\"_fbkvosharedcontroller\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#_fbkvosharedcontroller\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"_FBKVOSharedController\"]}),`\n`,(0,n.jsx)(e.p,{children:\"_FBKVOSharedController \\u88AB\\u8BBE\\u8BA1\\u6210\\u5355\\u4F8B\\uFF0C\\u7EDF\\u4E00\\u7BA1\\u7406KVO\\u901A\\u77E5\\u7684\\u63A5\\u6536\\u548C\\u8F6C\\u53D1\\u3002\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"@implementation\"}),` _FBKVOSharedController\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  NSHashTable\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\"_FBKVOInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_infos\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  pthread_mutex_t _mutex\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"_infos:  NSHashTable\\u7C7B\\u578B\\uFF0C\\u7C7B\\u4F3CNSSet\\uFF0C\\u540C\\u6837\\u4E5F\\u53EF\\u4EE5\\u8BBE\\u7F6E\\u5BF9\\u8C61\\u7684\\u5F3A\\u5F31\\u5F15\\u7528\\u3002\"}),`\n`,(0,n.jsx)(e.li,{children:\"_mutex\\uFF1A \\u4E92\\u65A5\\u9501\\uFF0C\\u4E3A\\u4E86\\u7EBF\\u7A0B\\u5B89\\u5168\\u3002\"}),`\n`]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"observe\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"id\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"object info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nullable _FBKVOInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`info\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// register info\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_lock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_mutex\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_infos addObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_unlock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_mutex\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// add observer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"object addObserver\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),\" forKeyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_keyPath options\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_options context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_state \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" _FBKVOInfoStateInitial\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_state \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" _FBKVOInfoStateObserving\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_state \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" _FBKVOInfoStateNotObserving\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"object removeObserver\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),\" forKeyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_keyPath context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"\\u5C06 info \\u52A0\\u5165 _infos.\"}),`\n`,(0,n.jsx)(e.li,{children:\"[object addObserver:self forKeyPath:info-\u003e_keyPath options:info-\u003e_options context:(void *)info] \\u4E3Aobject \\u6DFB\\u52A0\\u89C2\\u5BDF\\u8005\\u3002\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"\\u5728 _FBKVOSharedController \\u5B9E\\u73B0observeValueForKeyPath:ofObject:Change:context \\u63A5\\u6536\\u5904\\u7406\\u901A\\u77E5\\u3002\"}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.strong,{children:\"info = [_infos member:(__bridge id)context];\"}),`\n\\u5728 _infos \\u4E2D\\u627E\\u5230\\u5F53\\u524D _FBKVOInfo,\\u5E76\\u5BF9\\u5B83\\u8FDB\\u884C\\u4E00\\u4E2A\\u5F3A\\u5F15\\u7528\\u3002\\u5BF9\\u6570\\u636E\\u8FDB\\u884C\\u5C01\\u88C5\\uFF0C\\u6267\\u884C\\u6CE8\\u518C\\u7684\\u56DE\\u8C03\\u3002block\\uFF0C selector, \\u9ED8\\u8BA4\\u65B9\\u6CD5\\u3002`]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// take strong reference to controller\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    FBKVOController \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"controller \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_controller\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" controller\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// take strong reference to observer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      id observer \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" controller\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),\"observer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"!=\"}),\" observer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// dispatch custom block or action, fall back to default action\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          NSDictionary\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\"NSKeyValueChangeKey\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" id\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"changeWithKeyPath \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" change\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// add the keyPath to the change dictionary for clarity when mulitple keyPaths are being observed\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            NSMutableDictionary\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003c\"}),\"NSString \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" id\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"mChange \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"NSMutableDictionary dictionaryWithObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"keyPath forKey\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"FBKVONotificationKeyPathKey\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"mChange addEntriesFromDictionary\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"change\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"            changeWithKeyPath \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"mChange copy\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),(0,n.jsx)(e.span,{className:\"token function\",children:\"_block\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"observer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" object\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" changeWithKeyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_action\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"pragma\"}),\" \",(0,n.jsx)(e.span,{className:\"token expression\",children:\"clang diagnostic push\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"pragma\"}),\" \",(0,n.jsx)(e.span,{className:\"token expression\",children:\"clang diagnostic ignored \"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"-Warc-performSelector-leaks\"'})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"observer performSelector\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_action withObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"change withObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token macro property\",children:[(0,n.jsx)(e.span,{className:\"token directive-hash\",children:\"#\"}),(0,n.jsx)(e.span,{className:\"token directive keyword\",children:\"pragma\"}),\" \",(0,n.jsx)(e.span,{className:\"token expression\",children:\"clang diagnostic pop\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"else\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"observer observeValueForKeyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"keyPath ofObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"object change\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"change context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.strong,{children:\"unobserve\"}),\" ,\\u5728KVOController \",(0,n.jsx)(e.em,{children:\"dealloc()\"}),\" \\u65F6\\u4F1A\\u5C06 info \\u4ECE _infos\\u4E2D\\u79FB\\u9664\\uFF0C\\u5E76\\u7528\\u79FB\\u9664\\u89C2\\u5BDF\\u8005 \\uFF0C\\u4ECE\\u800C\\u5B9E\\u73B0\\u9690\\u5F0F\\u5730\\u79FB\\u9664KVO\\u3002\"]}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"unobserve\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"id\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"object info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nullable _FBKVOInfo \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`info\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"nil \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"return\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// unregister info\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_lock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_mutex\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"_infos removeObject\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token function\",children:\"pthread_mutex_unlock\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\"\u0026\"}),\"_mutex\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// remove observer\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"if\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_state \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"==\"}),\" _FBKVOInfoStateObserving\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"object removeObserver\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"self\"}),\" forKeyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_keyPath context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\"info\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  info\",(0,n.jsx)(e.span,{className:\"token operator\",children:\"-\u003e\"}),\"_state \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" _FBKVOInfoStateNotObserving\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h4,{id:\"_fbkvoinfo\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#_fbkvoinfo\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"_FBKVOInfo\"]}),`\n`,(0,n.jsx)(e.p,{children:\"_FBKVOInfo \\u5C06 \\u5C06\\u89C2\\u5BDF\\u8005\\u4FE1\\u606F\\u4FDD\\u5B58\\u5728\\u4E00\\u8D77\\uFF0C\\u5E76\\u4E14\\u91CD\\u5199\\u4E86 hash \\u548C isEqual\\uFF0C\\u4EE5 _keyPath\\u4F5C\\u4E3A\\u552F\\u4E00\\u6027\\u5224\\u65AD\\u4F9D\\u636E\\u3002\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-objectivec\",children:(0,n.jsxs)(e.code,{className:\"language-objectivec code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"@implementation\"}),` _FBKVOInfo\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"@public\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  __weak FBKVOController \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_controller\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  NSString \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_keyPath\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  NSKeyValueObservingOptions _options\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  SEL _action\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),\"_context\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  FBKVONotificationBlock _block\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  _FBKVOInfoState _state\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h3,{id:\"reference\",children:[(0,n.jsx)(e.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#reference\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Reference\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://github.com/facebook/KVOController\",children:\"KVOController\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"http://draveness.me/kvocontroller.html\",children:\"\\u5982\\u4F55\\u4F18\\u96C5\\u5730\\u4F7F\\u7528KVO\"})}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"[EOF]\"})]})}}var _=y;return g(v);})();\n;return Component;"},"isPost":true,"seoImage":{"url":"https://fninit.com/site-meta.png","dimensions":{"width":1120,"height":768}},"previewPosts":[],"prevPost":{"slug":"/posts/2017/linux-vimrc","title":"关于Vim不能正常显示中文的解决方法","date":"2017-07-10T02:04:03.000Z","excerpt":null,"draft":false,"page":false,"comment":true,"featureImage":{"url":"/images/altumcode-unsplash.webp","dimensions":{"width":1858,"height":1308}},"toc":null,"tags":[{"name":"linux","slug":"linux"},{"name":"vim","slug":"vim"}],"authors":[{"slug":"roninro","name":"Roninro","cover_image":"/images/publication-cover.png","profileImage":{"url":"/images/avatar.jpg","dimensions":{"width":1080,"height":1080}},"location":"THE INTERNET","bio":"Software Development Engineer","twitter":"@xxxxx","facebook":"xxxxxx"}],"primary_tag":{"name":"linux","slug":"linux"},"reading_time":"1 min read"},"nextPost":{"slug":"/posts/2017/ios-carthage","title":"Carthage 的简单使用","date":"2017-06-19T12:57:37.000Z","excerpt":null,"draft":false,"page":false,"comment":true,"featureImage":{"url":"/images/dNjMqj4emkc-unsplash.jpg","dimensions":{"width":2000,"height":1333}},"toc":null,"tags":[{"name":"iOS","slug":"ios"}],"authors":[{"slug":"roninro","name":"Roninro","cover_image":"/images/publication-cover.png","profileImage":{"url":"/images/avatar.jpg","dimensions":{"width":1080,"height":1080}},"location":"THE INTERNET","bio":"Software Development Engineer","twitter":"@xxxxx","facebook":"xxxxxx"}],"primary_tag":{"name":"iOS","slug":"ios"},"reading_time":"2 min read"},"bodyClass":"post-template tag-kvocontroller tag-ios"}},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["posts","2017","ios-KVOController"]},"buildId":"hNIbUDA85B46UOFY91l_c","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>