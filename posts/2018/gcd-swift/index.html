<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  
  
    
  

  <title>Swift 中的GCD  | RoninRo&#39;s Blog</title>

  
  <meta name="author" content="RoninRo">
  <meta name="description" content="
内容主要翻译自：



Grand Central Dispatch Tutorial for Swift 3: Part 1


Grand Central Dispatch Tutorial for Swft 3: Part 2


Grand Central Dispatch(GCD) 是管理并发操作的低级API，GCD 可以通过将计算量大的任务推迟到后台从而提高应用的响应速度。与锁和线程相比，它是一个更简单的并发模型。">
  <meta name="keywords" content="blog,developer,personal,golang">

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Swift 中的GCD "/>
<meta name="twitter:description" content="
内容主要翻译自：



Grand Central Dispatch Tutorial for Swift 3: Part 1


Grand Central Dispatch Tutorial for Swft 3: Part 2


Grand Central Dispatch(GCD) 是管理并发操作的低级API，GCD 可以通过将计算量大的任务推迟到后台从而提高应用的响应速度。与锁和线程相比，它是一个更简单的并发模型。"/>

  <meta property="og:title" content="Swift 中的GCD " />
<meta property="og:description" content="
内容主要翻译自：



Grand Central Dispatch Tutorial for Swift 3: Part 1


Grand Central Dispatch Tutorial for Swft 3: Part 2


Grand Central Dispatch(GCD) 是管理并发操作的低级API，GCD 可以通过将计算量大的任务推迟到后台从而提高应用的响应速度。与锁和线程相比，它是一个更简单的并发模型。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://roninro.github.io/posts/2018/gcd-swift/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-19T10:39:55+08:00" />
<meta property="article:modified_time" content="2018-05-19T10:39:55+08:00" />



  <link rel="stylesheet" href="/css/bootstrap.min.css" crossorigin="anonymous">
  
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
    type="text/css">

  
  
  <link rel="stylesheet" href="/sass/main.css">

  
  <link rel="stylesheet" href="/zoomjs/zoom.min.css">


  
  
  

  </head>



<body ontouchstart="">

  
  
  

  
  
  

  
  



<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://roninro.github.io/">RoninRo&#39;s Blog</a>
    </div>
    
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          
          <li><a href="/" title="Home">Home</a></li>
          
          <li><a href="/archive/" title="Archive">Archive</a></li>
          
          <li><a href="/categories/" title="Categories">Categories</a></li>
          
          <li><a href="/about/" title="About">About</a></li>
          

          <li class="search-icon">
            <a href="javascript:void(0)">
              <i class="fa fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
    
  </div>
  
</nav>
<script>
  
  
  
  var $body = document.body;
  var $toggle = document.querySelector(".navbar-toggle");
  var $navbar = document.querySelector("#huxblog_navbar");
  var $collapse = document.querySelector(".navbar-collapse");

  var __HuxNav__ = {
    close: function () {
      $navbar.className = " ";
      
      setTimeout(function () {
        
        if ($navbar.className.indexOf("in") < 0) {
          $collapse.style.height = "0px";
        }
      }, 400);
    },
    open: function () {
      $collapse.style.height = "auto";
      $navbar.className += " in";
    },
  };

  
  $toggle.addEventListener("click", function (e) {
    if ($navbar.className.indexOf("in") > 0) {
      __HuxNav__.close();
    } else {
      __HuxNav__.open();
    }
  });

  

  document.addEventListener("click", function (e) {
    if (e.target == $toggle) return;
    if (e.target.className == "icon-bar") return;
    __HuxNav__.close();
  });
</script>
  
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

  
  


<style type="text/css">
  header.intro-header {
    position: relative;
    background-image: url('');
  }
</style>

<header class="intro-header style-text">

  <div class="header-mask"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags">
            
            <a class="tag" href="/tags/ios/" title="iOS">iOS</a>
            
            <a class="tag" href="/tags/gcd/" title="gcd">gcd</a>
            
            <a class="tag" href="/tags/swift/" title="Swift">Swift</a>
            
          </div>
          <h1>Swift 中的GCD </h1>
          <h2 class="subheading"></h2>
          <span class="meta">
            Posted by  RoninRo 
            on Sat, May 19, 2018
          </span>
        </div>
      </div>
    </div>
  </div>
</header>


  


<article>
  <div class="container">
    <div class="row">

      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              post-container">
        <blockquote>
<p>内容主要翻译自：</p>
</blockquote>
<blockquote>
<ol>
<li><a href="https://www.raywenderlich.com/148513/grand-central-dispatch-tutorial-swift-3-part-1">Grand Central Dispatch Tutorial for Swift 3: Part 1</a></li>
</ol>
<ul>
<li><a href="https://www.raywenderlich.com/148515/grand-central-dispatch-tutorial-swift-3-part-2">Grand Central Dispatch Tutorial for Swft 3: Part 2</a></li>
</ul>
</blockquote>
<p>Grand Central Dispatch(GCD) 是管理并发操作的低级API，GCD 可以通过将计算量大的任务推迟到后台从而提高应用的响应速度。与锁和线程相比，它是一个更简单的并发模型。</p>
<p>在 Swift 3 中， GCD 得到了重大改进，从基于 C 的 API 转向包含新类和新的数据结构的 Swiftier API。</p>
<p>建立在名为 GooglyPuff 的现有应用程序上。 GooglyPuff 是一款未优化的，“线程不安全”的应用程序，它使用Core Image的人脸检测API，在检测到的人脸上覆盖Google眼睛。您可以从照片库中选择图像,或选择从互联网上下载图像应用此效果。</p>
<h1 id="-part-1-">[ Part 1 ]<a class="anchorjs-link" href="#-part-1-"></a></h1><h2 id="getting-started">Getting Started<a class="anchorjs-link" href="#getting-started"></a></h2><p>下载 <a href="https://koenig-media.raywenderlich.com/uploads/2016/12/GooglyPuff_Swift3_Part1_Starter.zip">starter project</a>
并在 Xcode 中打开它。</p>
<p>主屏幕最初是空的，点击 + 然后选择 <strong>Le Internet</strong> 从网络下载预定义的图像，点击第一张图片，会看到添加在脸上的有趣的眼睛。</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/1805-starter_app_flow.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>本教程中将主要介绍四个类：</p>
<ul>
<li><code>PhotoCollectionViewController</code>: 初始视图控制器，将所选照片显示为缩略图。</li>
<li><code>PhotoDetailViewController</code>：显示从 <code>PhotoCollectionViewController</code> 选择的缩略图，并将 小眼睛尖添加到图片上。</li>
<li><code>Photo</code>：这是描述照片属性的协议。它提供了图像，缩略图及其相应的状态。
两个实现协议的类：DownloadPhoto，用于从URL实例实例化照片;
AssetPhoto，用于实例化来自PHAsset实例的照片。</li>
<li><code>PhotoManager</code>: 管理所有的 <code>Photo</code> 对象。</li>
</ul>
<p>该应用有几个问题。运行应用程序时可能会注意到的一点是，下载完成警告为时过早。您将在本系列的第二部分中解决这个问题。</p>
<p>在第一部分中，您将进行一些改进，包括优化googly-fying过程并使PhotoManager线程安全。</p>
<h2 id="gcd-概念">GCD 概念<a class="anchorjs-link" href="#gcd-%e6%a6%82%e5%bf%b5"></a></h2><p>要理解GCD，需要熟悉与并发和线程相关的几个概念。</p>
<h2 id="concurrency-并发">Concurrency （并发）<a class="anchorjs-link" href="#concurrency-%e5%b9%b6%e5%8f%91"></a></h2><p>在 iOS 中，一个进程或者应用程序由一个或多个线程组成，这些线程由操作系统调度程序独立管理。
每个线程可以同时执行，但是这种情况产生或者如何如何产生由系统决定。</p>
<p>单核设备可以通过<code>time-slicing</code>(时间切片)。他们将运行一个线程，执行上下文切换，然后运行另一个线程。</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/1805-Concurrency_vs_Parallelism.png" data-action="zoom" alt="Concurrency_vs_Parallelism"  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>多核设备通过并行执行同时执行多个线程。</p>
<p>GCD建立在线程之上。它下面管理一个共享线程池。使用GCD可以添加代码块或工作项来分派队列，GCD决定在哪个线程上执行它们。</p>
<p>在你构建你的代码时，你会发现有些代码块可以同时运行，有些不行。这就允许你使用GCD来利用并发执行。</p>
<p>请注意，GCD根据系统和可用系统资源决定需要多少并行性。重要的是要注意并行性需要并发性，但并发并不能保证并行性。</p>
<p>基本上，并发是关于结构，而并行则是关于执行。</p>
<h2 id="queues-队列">Queues (队列)<a class="anchorjs-link" href="#queues-%e9%98%9f%e5%88%97"></a></h2><p>GCD提供由 <code>DispatchQueue</code> 表示的调度队列来管理您提交的任务，并以来执行它们，以确保提交的第一项任务是第一个开始。</p>
<p>Dispatch queues 是线程安全的，这意味着你可以同时从多个线程访问它们。
当您了解调度队列如何为自己的代码的某些部分提供线程安全性时，GCD的好处就显而易见了。关键在于选择正确的调度队列和正确的调度功能将您的工作提交给队列。</p>
<p>队列可以是串行(serial)或并发(concurrent)的。
串行队列保证在任何给定的时间只有一个任务运行。 GCD控制执行时间。
你不会知道一个任务结束和下一个任务开始之间的时间长短：</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/Serial-Queue-Swift.png" data-action="zoom" alt="Serial Queue Swift"  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>并发队列允许同时运行多个任务。保证任务按照他们添加的顺序开始。任务可以按任意顺序完成，并且您不知道下次启动任务所需的时间，也不知道在任何给定时间运行的任务数量。</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/Concurrent-Queue-Swift.png" data-action="zoom" alt="Concurrent-Queue-Swift"  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>何时开始任务的决定完全取决于GCD。
如果一个任务的执行时间与另一个任务的执行时间重叠，则由GCD决定是否应该在不同的核心上运行（如果有），或者执行上下文切换以运行不同的任务。</p>
<p>GCD 提供三种主要类型的队列：</p>
<ul>
<li><strong>Main queue</strong>: 在主线程上运行并且是一个串行队列。</li>
<li><strong>Global  queues</strong>: 并发队列由整个系统共享。有四个这样的队列具有不同的优先级：high, default, low, and background。后台优先级队列被 I/O 限制。</li>
<li><strong>Custom queues</strong>: 您创建的队列可以是串行或并发的。实际这些都是由全局队列控制的。</li>
</ul>
<p>设置全局并发队列时，不要直接指定优先级。而是指定一个服务质量（QoS）类属性。这将表明任务的重要性，并指导GCD确定优先任务。</p>
<p>QoS 类：</p>
<ul>
<li><strong>User-interactive</strong>: 任务需要立即完成以提供良好的用户体验。
用于UI更新，事件处理和需要低延迟的小型工作负载。</li>
<li><strong>User-initiatd</strong>: 任务从UI启动，可以异步执行。应在用户等待立即结果时使用，以及用于继续用户交互所需的任务。这将被映射到高优先级的全局队列中。</li>
<li><strong>Utility</strong>: 代表长时间运行的任务，通常具有用户可见的进度指示器。将其用于计算，I / O，网络连接，连续数据馈送和类似任务。本课程旨在提高能源效率。这将被映射到低优先级的全局队列中。</li>
<li><strong>Background</strong>: 这表示用户没有直接意识到的任务。将其用于预取，维护和其他不需要用户交互且时间不敏感的任务。这将被映射到后台优先级全局队列中。</li>
</ul>
<h3 id="同步-vs-异步">同步 vs 异步<a class="anchorjs-link" href="#%e5%90%8c%e6%ad%a5-vs-%e5%bc%82%e6%ad%a5"></a></h3><p>通过GCD，可以同步或者异步分派任务</p>
<p>同步函数在任务完成后将控制权返回调用者。</p>
<p>异步函数立即返回，命令完成任务但不等待它。因此，异步函数不会阻止当前的执行线程继续执行下一个函数。</p>
<h3 id="管理任务">管理任务<a class="anchorjs-link" href="#%e7%ae%a1%e7%90%86%e4%bb%bb%e5%8a%a1"></a></h3><p>到目前为止，你已经听说过很多“任务”。为了本教程的目的，您可以将任务视为 <a href="https://developer.apple.com/library/prerelease/ios/documentation/Swift/Conceptual/Swift_Programming_Language/Closures.html">closure</a>。闭包是可以存储和传递的自包含，可调用的代码块。</p>
<p>你提交到 <code>DispatchQueue</code> 的任务被封装成 <code>DispatchWorkItem</code>。您可以配置 <code>DispatchWorkItem</code> 的行为，例如其QoS等级或是否产生新的分离线程(detached thread)。</p>
<h2 id="处理后台任务">处理后台任务<a class="anchorjs-link" href="#%e5%a4%84%e7%90%86%e5%90%8e%e5%8f%b0%e4%bb%bb%e5%8a%a1"></a></h2><p>回到 app，从你的相册或者 使用 <strong>Le Internet</strong> 选项去下载一些图片。点击一个照片，注意照片线节显示花费了多长时间。在较慢的设备上查看较大图像时，延迟更加明显。</p>
<p>重载视图控制器的viewDidLoad（）很容易造成视图出现之前的长时间等待。如果它在加载时不是绝对必要的，最好将工作移到后台。</p>
<p>听起来像 <code>DispatchQueue</code> 的 异步工作模式。</p>
<p>打开 <strong>PhotoDetailViewController.swift</strong> 在 <code>viewDidLoad()</code> 中替换下面两行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>let overlayImage = faceOverlayImageFromImage(image)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>fadeInNewImage(overlayImage)
</span></span></code></pre></div><p>替换后：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>DispatchQueue.global(qos: .userInitiated).async { <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">overlayImage</span> = <span style="color:#ff79c6">self</span>.faceOverlayImageFromImage(<span style="color:#ff79c6">self</span>.image)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    DispatchQueue.main.async { <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>      <span style="color:#ff79c6">self</span>.fadeInNewImage(overlayImage) <span style="color:#6272a4">// 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>}
</span></span></code></pre></div><p>一步一步来看代码做了什么：</p>
<ol>
<li>
<p>将任务移动到后台全局队列，并且在闭包中执行。这使得 <code>viewDidLoad()</code> 在主线程中更早的完成，使加载感觉瞬间完成。同时，人脸检测处理开始并在稍后的时间结束。</p>
</li>
<li>
<p>人脸检测处理已完成，并且已生成新图像。既然你想使用这个新的图像来更新你的UIImageView，你可以在主队列中添加一个新的闭包。请记住 - 您必须始终访问主线程上的UIKit类！</p>
</li>
<li>
<p>最后，用<code>fadeInNewImage(_ :)</code>更新UI，执行新的googly眼睛图像的淡入转换。</p>
</li>
</ol>
<p>构建并运行应用程序。通过<code>Le Internet</code>选项下载照片。选择一张照片，你会注意到视图控制器加载速度明显加快，并在短暂延迟后添加了googly眼睛</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/after_background_task_2.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>这增加了应用程序的前后效果，因为添加了googly眼睛。即使你试图加载一个非常庞大的图像，你的应用程序也不会像加载视图控制器时那样挂起。</p>
<p>一般来说，当你需要基于网络或CPU密集型任务，您会希望使用异步在后台执行,并且不阻止当前线程时。</p>
<p>下面是如何以及何时使用各种异步队列的快速指南：</p>
<ul>
<li>
<p><strong>Main Queue</strong>：常用的选择是在完成并发队列任务后更新 UI。
要做到这一点，你会在另一个代码中编写一个闭包。定位主队列并调用 <code>async</code> 保证此新任务将在当前方法结束后的某个时间执行。</p>
</li>
<li>
<p><strong>Global Queue</strong>: 在后台执行 非 UI 任务。</p>
</li>
<li>
<p><strong>Custom Serial Queue</strong>: 当你想要连续执行后台工作并跟踪它时，这是一个不错的选择。
这消除了资源争用，因为一次只有一个任务正在执行。
请注意，如果您需要方法中的数据，则必须内联另一个闭包以检索它或者考虑使用<code>sync</code>。</p>
</li>
</ul>
<h2 id="delaying-task-execution-延迟任务执行">Delaying Task Execution （延迟任务执行）<a class="anchorjs-link" href="#delaying-task-execution-%e5%bb%b6%e8%bf%9f%e4%bb%bb%e5%8a%a1%e6%89%a7%e8%a1%8c"></a></h2><p><code>DispatchQueue</code> 允许你延迟任务执行，应该注意不要使用它来解决竞争条件或其他时间BUG，比如引入延迟等黑科技。
当您想要任务在特定时间运行时使用此功能。</p>
<p>考虑一下你的App 的用户体验。用户可能会对第一次打开应用程序时应该怎么做感到困惑 - 不是吗？</p>
<p>如果没有任何照片，向用户显示提示是个不错的主意。
您还应该考虑用户的眼睛如何导航主屏幕。
如果您显示的提示太快，他们可能会错过它，因为他们的眼睛萦绕在视图的其他部分。显示提示前一秒延迟应足以吸引用户的注意力并引导他们。</p>
<p>打开 <strong>PhotoCollectionViewController.swift</strong>  填写 <code>showOrHideNavPrompt()</code> 方法的实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">delayInSeconds</span> = <span style="color:#bd93f9">1.0</span> <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>DispatchQueue.main.asyncAfter(deadline: .now() <span style="color:#ff79c6">+</span> delayInSeconds) { <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">count</span> = PhotoManager.sharedManager.photos.count
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    <span style="color:#ff79c6">if</span> count <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>      <span style="color:#ff79c6">self</span>.navigationItem.prompt = <span style="color:#ff79c6">nil</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>      <span style="color:#ff79c6">self</span>.navigationItem.prompt = <span style="color:#f1fa8c">&#34;Add photos with faces to Googlyify them!&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><ol>
<li>指定一个延迟时间的变量</li>
<li>等待指定的时间，然后异步运行更新照片数量的代码并且更新提示。</li>
</ol>
<p><code>showOrHideNavPrompt()</code> 在 <code>viewDidLoad()</code> 和 <code>UICollectionView</code> 重新加载时运行。</p>
<p>构建并运行应用程序。显示提示之前应该会有稍微延迟：</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/app_with_prompt_2.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>想知道什么时候适合使用 <code>asyncAfter</code> ？通常在主队列中使用它是一个不错的选择。
在其他队列（如全局背景队列或自定义串行队列）上使用 <code>asyncAfter</code> 时，需要谨慎。
最好坚持在主队列。</p>
<p>为什么不使用 <code>Timer</code>？你可以考虑使用它，如果你有重复的任务更容易使用 <code>Timer</code> 来安排。
这里有两个坚持使用调度队列的<code>asyncAfter</code> 的原因。</p>
<p>可读性。要使用Timer，您必须定义一个方法，然后使用选择器或调用定义的方法来创建定时器。有了 <code>DispatchQueue</code> 和 <code>asyncAfter</code> ，你只需添加一个闭包。</p>
<p><code>Timer</code> 在run loops (运行循环)中，因此还必须确保它在你希望启动的 run loop 上进行q触发（并且在某些情况下为正确的运行循环模式）。在这方面，使用调度队列更容易。</p>
<h2 id="managing-singletons管理单例">Managing Singletons（管理单例）<a class="anchorjs-link" href="#managing-singletons%e7%ae%a1%e7%90%86%e5%8d%95%e4%be%8b"></a></h2><p>关于单例，一个常见的问题是他们并不是线程安全的。考虑到它们的使用，这种担心是合理的：singletons通常用于同时访问单例实例的多个控制器。你的PhotoManager类是一个单例，所以你需要考虑这个问题。</p>
<p>线程安全代码可以安全地从多线程或并发任务中调用，而不会导致任何问题，如数据损坏或应用程序崩溃。不是线程安全的代码一次只能在一个上下文中运行。</p>
<p>在单例实例的初始化期间以及读取和写入实例期间，需要考虑两个线程安全情况。</p>
<p>由于Swift初始化全局变量的方式，初始化变成了一种简单的情况。
全局变量在首次访问时被初始化，并且它们保证以原子方式初始化。
也就是说，执行初始化的代码被视为临界区，并且在任何其他线程访问全局变量之前保证完成。</p>
<p>关键部分是一段不能并发执行的代码，即一次执行两个线程。
这通常是因为代码操纵共享资源，例如变量，如果它被并发进程访问，它可能会被破坏。</p>
<p>打开 <strong>PhotoManager.swift</strong> 来看单例是如何初始化的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_sharedManager</span> = PhotoManager()
</span></span></code></pre></div><p>私有的全局变量 <code>_sharedManager</code> 被用于惰性地初始化<code>PhotoManager</code>。
这只发生在第一次访问：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">var</span> sharedManager: PhotoManager {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  <span style="color:#ff79c6">return</span> _sharedManager
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>公开变量（public）<code>sharedManager</code> 返回 私有的 <code>_sharedManager</code>,Swift确保这个操作是线程安全的。</p>
<p>在访问处理共享内部数据的单例中的代码时，您仍然必须处理线程安全。您可以通过同步数据访问等方法来处理此问题。你会在下一节看到一种方法。</p>
<h2 id="handling-the-readers-writers-problems-处理读写问题">Handling the Readers-Writers Problems （处理读写问题）<a class="anchorjs-link" href="#handling-the-readers-writers-problems-%e5%a4%84%e7%90%86%e8%af%bb%e5%86%99%e9%97%ae%e9%a2%98"></a></h2><p>在Swift中，任何用<code>let</code>关键字声明的变量都被认为是一个常量，并且是只读和线程安全的。
然而，用<code>var</code>关键字声明变量，除非数据类型被设计成这样，否则它变成可变的并且不是线程安全的。
当声明为可变时，像Array和Dictionary这样的Swift集合类型不是线程安全的。</p>
<p>虽然许多线程可以同时读取数组的可变实例而不会出现问题，但在另一个线程正在读取数组的同时让一个线程修改数组并不安全。
单例并不能阻止这种情况发生在目前的状态。</p>
<p>看看下面的问题，<code>addPhoto(_:)</code> 在 <strong>PhotoManager.swift</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">addPhoto</span>(<span style="color:#ff79c6">_</span> photo: Photo) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  _photos.append(photo)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    DispatchQueue.main.async {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>      <span style="color:#ff79c6">self</span>.postContentAddedNotification()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>}
</span></span></code></pre></div><p>这是一个 <code>write</code> 方法，因为它修改了一个可变数组对象。</p>
<p>看看 <code>photos</code> 属性:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>fileprivate <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">_photos</span>: [Photo] = []
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span><span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">photos</span>: [Photo] {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>  <span style="color:#ff79c6">return</span> _photos
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>该属性的getter在读取可变数组时被称为 <code>read</code> 方法。调用者获取数组的一个副本，并受到保护，以防止不适当地改变原始数组。
这不会对一个线程调用write方法 <code>addPhoto(_:)</code>提供任何保护，同时另一个线程调用photos属性的getter。</p>
<blockquote>
<p><em>Note</em>: 在上面的代码中，为什么调用者获得照片数组的 copy ？在Swift中，函数的参数和返回类型是通过引用或按值传递的。</p>
</blockquote>
<blockquote>
<p>按值传递会导致对象的 copy ，并且对 copy 的更改不会影响原始数据。
默认情况下，Swift类实例通过引用传递，结构通过值传递。
Swift的内置数据类型，如数组和字典，被实现为结构体。</p>
</blockquote>
<blockquote>
<p>它可能看起来像在代码中来回传递集合时有很多 coping 。
不要担心这个内存使用的影响。 Swift集合类型经过优化，只在必要时才进行复制，例如，在传递数值时第一次修改数组。</p>
</blockquote>
<p>这是经典的软件开发 <a href="https://en.wikipedia.org/wiki/Readers%E2%80%93writers_problem">Reader-Writers Problem</a>。
GCD 通过使用 <code>dispatch barriers</code> 创建一个 <a href="https://en.wikipedia.org/wiki/Readers%E2%80%93writer_lock">read/write lock</a> 提供了一个优雅的解决方式。
Dispatch barriers 是一组函数，当处理并发队列，作为串行式的瓶颈(serial-style bottleneck)</p>
<p>将 <code>DispatchWorkItem</code> 提交到调度队列时，可以设置标志来指示它应该是在特定时间内在指定队列上执行的唯一项目。
这意味着在 dispatch barrier 之前提交给队列的所有项目必须在 <code>DispatchWorkItem</code> 执行之前完成。</p>
<p>当轮到 <code>DispatchWorkItem</code> 执行时，barrier 执行它并确保队列在此期间不执行任何其他任务。完成后，队列返回到其默认实现。</p>
<p>下图说明了 barrier 对各种异步任务的影响:</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/Dispatch-Barrier-Swift.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>注意，在正常操作中，队列的行为如同正常的并发队列。
但是，当 barrier 执行时，它本质上就像一个串行队列。
也就是说，barrier 是唯一执行的事情。barrier 完成后，队列返回正常并发队列。</p>
<p>在全局后台并发队列中使用 barriers 时要小心，因为这些队列是共享资源。
在自定义串行队列中使用 barrier 是多余的，因为它已经是连续执行。
在自定义并发队列中使用 barrier 是处理关键代码线程安全性的绝佳选择。</p>
<p>使用自定义并发队列来处理 barrier 功能并分离读取和写入功能。并发队列将允许同时进行多个读取操作。</p>
<p>打开 <strong>PhotoManager.swift</strong>  并且在<code>_photos</code> 声明之上添加一个私有属性.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>fileprivate <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">concurrentPhotoQueue</span> =
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>DispatchQueue(
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    label: <span style="color:#f1fa8c">&#34;com.raywenderlich.GooglyPuff.photoQueue&#34;</span>, <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    attributes: .concurrent) <span style="color:#6272a4">// 2</span>
</span></span></code></pre></div><ol>
<li>
<p>您使用描述性名称设置 <code>label</code>，该标签在调试过程中很有帮助。通常，使用反转的DNS样式命名约定。</p>
</li>
<li>
<p>指定一个并发队列。</p>
</li>
</ol>
<p>使用下面的代码替换 <code>addPhoto(_:)</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">addPhoto</span>(<span style="color:#ff79c6">_</span> photo: Photo) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  concurrentPhotoQueue.async(flags: .barrier) { <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    <span style="color:#ff79c6">self</span>._photos.append(photo) <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>      DispatchQueue.main.async { <span style="color:#6272a4">// 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>        <span style="color:#ff79c6">self</span>.postContentAddedNotification()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>      }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><ol>
<li>使用 barrier 异步分派写入操作。它执行时，它将成为队列中唯一的项目。</li>
<li>添加对象到数组中。</li>
<li>最后，发布一条通知，说明你已经添加了照片。这个通知应该发布在主线程上，因为它会做UI工作。因此，你将另一个任务异步分派到主队列以触发通知。</li>
</ol>
<p>这需要照顾写入，但是你还需要实现照片读取方法。</p>
<p>为确保写入时线程安全，你需要在 <code>concurrentPhotoQueue</code> 上执行读取操作。
你需要从函数调用返回数据，所以异步调度不会削减它。
在这种情况下， <code>sync</code> 将是一个很好的候选人。</p>
<p>使用 <code>sync</code> 使用来跟踪工作中的 dispatch barrier ，或者在需要等待操作完成时才能使用由闭包处理的数据。</p>
<p>你需要小心！想象一下，如果您调用 <code>sync</code> 并且你已经在运行的当前队列。这将导致死锁情况。</p>
<p>两个（或有时更多）项目（大多数情况下是线程）被阻塞，如果他们都等待对方完成或执行另一个操作。
第一个无法完成，因为它正在等待第二个完成。但第二个也无法完成，因为它正在等待第一个完成。</p>
<p>在上面的情况， <code>sync</code> 将一直等到闭包完成，但闭包不能完成（它甚至不能启动！），直到当前正在执行的闭包完成，这不能！
这应该强制你意识到你在呼叫哪个队列 - 以及你通过哪个队列。</p>
<p>下面简要介绍在什么情况下使用 <code>sync</code> ：</p>
<ul>
<li><strong>Main Queue</strong>: 出于与上述相同的原因, 要&quot;非常&quot;小心。这种情况也有可能造成死锁。</li>
<li><strong>Global Queue</strong>: 这是一个好的选择，通过 dispatch barrier` 做同步工作，或等待任务完成时同步工作，然后可以执行进一步处理。</li>
<li><strong>Custom Serial Queue</strong> : 您正在队列中运行并以同一队列为目标调用同步，则肯定会造成死锁。</li>
</ul>
<p>仍然在 <strong>PhotoManager.swift</strong> 中改动 <code>photos</code> 属性的 getter :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">photos</span>: [Photo] {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">photosCopy</span>: [Photo]<span style="color:#ff79c6">!</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    concurrentPhotoQueue.sync { <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>      photosCopy = <span style="color:#ff79c6">self</span>._photos <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>  <span style="color:#ff79c6">return</span> photosCopy
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><ol>
<li>同步发送到 <code>concurrentPhotoQueue</code> 以执行读取。</li>
<li>将照片数组的 copy 存储在 photosCopy 中并将其返回。</li>
</ol>
<p>构建并运行应用程序。
通过 Le Internet 选项下载照片。
它应该像以前一样行动，但是在引擎盖下，你有一些非常快乐的线程。</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/starter_photos_2.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>恭喜 - PhotoManager单例 现在是线程安全的。无论你在哪里或如何阅读或写照片，你都可以确信，这将以安全的方式完成，不会有任何意外。</p>
<h1 id="-part-2-">[ Part 2 ]<a class="anchorjs-link" href="#-part-2-"></a></h1><h2 id="getting-started-1">Getting Started<a class="anchorjs-link" href="#getting-started-1"></a></h2><p>运行 app，点击 + ，然后选择 <strong>Le Internet</strong> 来添加网络图片，你可能注意到下载完成警报消息在图像下载完成之前弹出：</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/photos_early_alert_2.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>这是你要解决的第一件事.</p>
<h2 id="dispatch-groups">Dispatch Groups<a class="anchorjs-link" href="#dispatch-groups"></a></h2><p>打开 <strong>PhotoManager.swift</strong>  并查看 <code>downloadPhotosWithCompletion(\_:)</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">downloadPhotosWithCompletion</span>(<span style="color:#ff79c6">_</span> completion: BatchPhotoDownloadingCompletionClosure?) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>  <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">storedError</span>: NSError?
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#ff79c6">for</span> address <span style="color:#ff79c6">in</span> [overlyAttachedGirlfriendURLString, successKidURLString, lotsOfFacesURLString] {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>          <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = URL(string: address)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>            <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">photo</span> = DownloadPhoto(url: url!) { <span style="color:#ff79c6">_</span>, error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                <span style="color:#ff79c6">if</span> error <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                  storedError = error
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>            }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>          PhotoManager.sharedManager.addPhoto(photo)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>        }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>  completion?(storedError)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><p>该警告由传入该方法的 completion 闭包触发。
这是在下载照片的for循环之后调用的。错误地认为在调用闭包之前下载已完成。</p>
<p>通过调用 <code>DownloadPhoto(url:)</code> 启动照片下载。调用立刻返回，但实际下载是异步发生的。
因此，当 <code>completion</code> 调用时，不能保证所有下载都完成。</p>
<p>你想要 <code>downloadPhotosWithCompletion(_:)</code> 在所有照片下载完成后调用它的 <code>completion</code> 闭包，如何监控这些并发异步事件以实现这一目标？使用当前的方法，你不知道任务何时完成，并且可以按任何顺序完成。</p>
<p>好消息！，这正是 dispatch groups 要处理的。
使用 dispatch groups 可以将多个任务分组在一起，并等待它们完成或在完成后通知他们。任务可以是异步或者同步，甚至可以在不同的队列上运行。</p>
<p><strong>DispatchGroup</strong> 管理着 dispatch groups. 先看它的 <code>wait</code> 方法。
这会阻止当前线程，直到所有组的入队任务完成。</p>
<p>在 <strong>PhotoManager.swift</strong> 并且替换 <code>downloadPhotosWithCompletion(_:)</code> 代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>DispatchQueue.global(qos: .userInitiated).async { <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>  <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">storedError</span>: NSError?
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">downloadGroup</span> = DispatchGroup() <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>  <span style="color:#ff79c6">for</span> address <span style="color:#ff79c6">in</span> [overlyAttachedGirlfriendURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                  successKidURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                  lotsOfFacesURLString] {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = URL(string: address)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    downloadGroup.enter() <span style="color:#6272a4">// 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">photo</span> = DownloadPhoto(url: url!) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>      <span style="color:#ff79c6">_</span>, error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>      <span style="color:#ff79c6">if</span> error <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        storedError = error
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>      }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>      downloadGroup.leave() <span style="color:#6272a4">// 4</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    PhotoManager.sharedManager.addPhoto(photo)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>  downloadGroup.wait() <span style="color:#6272a4">// 5</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>  DispatchQueue.main.async { <span style="color:#6272a4">// 6</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    completion?(storedError)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>}
</span></span></code></pre></div><ol>
<li>因为使用同步方法 <code>wait</code> ，它会阻塞当前线程，所以可以使用 <code>async</code> 将整个方法放入后台队列中，来确保不会阻塞主线程。</li>
<li>这里创建一个新的 <code>dispatch group</code>。</li>
<li>调用 <code>enter()</code> 来手动通知 <code>group</code> 任务已经开始了。你必须调用 <code>leave()</code> 来平衡 <code>enter()</code> 的调用次数，否则程序会崩溃。</li>
<li>这里通知 <code>group</code> 任务已经完成。</li>
<li>当等待任务完成时，调用 <code>call()</code> 阻塞当前线程。永远等待，因为照片创建问题完成的。
你可以使用 <code>wait(timeout:)</code> 指定一个超时时间，当超过时间后，会从等待状态中脱离出来。</li>
<li>此时，可以保证所有图像任务已经完成或者超时，然后，回到主线程运行 <code>completion</code> 闭包。</li>
</ol>
<p>构建并运行应用程序。通过 Le Internet 选项下载照片并确认在下载所有图像之前警告不会显示。</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/fixed_early_popup.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p><code>Dispatch group</code> 适合所有类型的队列。如果你正在等待完成所有的工作，因为你不想阻塞主线程，你应该警惕在主线程上使用 <code>dispatch queue</code>。
但是异步模型是一个很有吸引力的方式，当长时间运行的任务完成后更新UI，如网络请求。</p>
<p>目前的解决方案是好的，但总的来说，如果可能的话最好避免阻塞线程。下一个任务是重写相同的方法，以便在所有下载完成后异步通知您。</p>
<h2 id="dispatch-groups-task-2">Dispatch Groups, Task 2<a class="anchorjs-link" href="#dispatch-groups-task-2"></a></h2><p>使用 <code>wait</code> 方法异步调度到另一个队列是笨拙的。幸好有一个更好的方法。<strong>DispatchGroup</strong> 可以在所有 <code>group</code> 的任务完成时改为通知。</p>
<p>仍然在__PhotoManager.swift__ 中，<code>downloadPhotosWithCompletion(_:)</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">storedError</span>: NSError?
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">downloadGroup</span> = DispatchGroup()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#ff79c6">for</span> address <span style="color:#ff79c6">in</span> [overlyAttachedGirlfriendURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                successKidURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                lotsOfFacesURLString] {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = URL(string: address)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  downloadGroup.enter()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">photo</span> = DownloadPhoto(url: url!) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#ff79c6">_</span>, error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    <span style="color:#ff79c6">if</span> error <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>      storedError = error
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    }   
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    downloadGroup.leave()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>  }   
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>  PhotoManager.sharedManager.addPhoto(photo)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>}   
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>downloadGroup.notify(queue: DispatchQueue.main) { <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>  completion?(storedError)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>}
</span></span></code></pre></div><ol>
<li>在这个新的实现中，你不需要将方法包围在一个 <code>async</code> 中调用，因为你没有阻塞主线程。</li>
<li><code>notify(queue:work:)</code> 作为异步完成闭包。它可以在 item 离开 <code>group</code> 时调用，你还指定在主队列上运行完成工作。</li>
</ol>
<p>这是处理这个特定工作的更简洁的方式，因为它不会阻塞任何线程。</p>
<p>构建并运行应用程序。确认所有互联网照片下载完成后都仍显示完成警告.</p>
<h3 id="concurrency-looping并发循环">Concurrency Looping（并发循环）<a class="anchorjs-link" href="#concurrency-looping%e5%b9%b6%e5%8f%91%e5%be%aa%e7%8e%af"></a></h3><p><figure>
  <a class="paragraph-image">
    <img src="/media/Thread_All_The_Code_Meme.jpg" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>看一看 <strong>PhotoManager</strong> 的 <code>downloadPhotosWithCompletion(_:)</code> 方法，你会注意到有一个<code>for</code> 循环，循环三次迭代并下载三个单独的图像。
你的工作是看看你是否可以同时运行这个循环来尝试和加快速度。</p>
<p>这是 <code>DispatchQueue.concurrentPerform(iterations:execute:)</code> 的工作。
它与for 循环的工作方式类似，它同时执行不同的迭代。它是同步的并且只有在所有工作完成后才返回。</p>
<p>在为给定工作量计算最佳迭代次数时必须小心。
许多迭代和每次迭代的少量工作可能会产生太多的开销，从而使得调用并发的任何收益都无效。
这种称为“跨步”的技术可以帮助你在这里。
这是每次迭代都要完成多项工作的地方。</p>
<p>什么时候去使用 <code>DispatchQueue.concurrentPerform(iterations:execute:)</code>呢？
你可以排除串行队列，因为没有任何好处 - 你也可以使用正常的循环。
对于包含循环的并发队列来说，这是一个很好的选择，尤其是在需要跟踪进度时。</p>
<p>还是在 <code>downloadPhotosWithCompletion(_:)</code> 方法中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">storedError</span>: NSError?
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">downloadGroup</span> = DispatchGroup()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">addresses</span> = [overlyAttachedGirlfriendURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                 successKidURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                 lotsOfFacesURLString]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_</span> = DispatchQueue.global(qos: .userInitiated)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>DispatchQueue.concurrentPerform(iterations: addresses.count) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  i <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">index</span> = <span style="color:#8be9fd;font-style:italic">Int</span>(i)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">address</span> = addresses[index]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = URL(string: address)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>  downloadGroup.enter()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">photo</span> = DownloadPhoto(url: url!) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#ff79c6">_</span>, error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    <span style="color:#ff79c6">if</span> error <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>      storedError = error
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    downloadGroup.leave()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>  PhotoManager.sharedManager.addPhoto(photo)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>downloadGroup.notify(queue: DispatchQueue.main) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>  completion?(storedError)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>}
</span></span></code></pre></div><p>前一个 for 循环已经被替换为 <code>DispatchQueue.concurrentPerform</code> 来处理并发循环。</p>
<p>在设备上运行此新代码偶尔会产生稍微更快的结果。但是，所有这些工作值得吗？</p>
<p>其实在这种情况下不值得。原因如下：</p>
<ul>
<li>你可能已经创建了更多的并行运行线程，而不是只是首先运行for循环。你应该使用 <code>DispatchQueue.concurrentPerform(iterations:execute:)</code> 用于迭代非常大的集合以及适当的步长。</li>
<li>您创建应用程序的时间有限 - 不要浪费时间预先优化您不知道的代码已损坏的代码。如果你要优化某些东西，优化一些值得注意并值得花时间的事情。
通过 <code>Instruments</code> 分析你的应用来查找执行时间最长的方法。</li>
<li>通常情况下，优化代码会使您的代码对于您和其他开发者而言更加复杂。确保增加的复杂功能是值得的。</li>
</ul>
<p>请记住，不要为优化而优化。你只会让自己和其他必须通过代码遍历的人变得更加困难。</p>
<h2 id="cancelling-dispatch-blocks">Cancelling Dispatch Blocks<a class="anchorjs-link" href="#cancelling-dispatch-blocks"></a></h2><p>到目前为止，您还没有看到允许您取消入队任务的代码。
这里是 <code>dispatch block objects</code>由 DispatchWorkItem 表示成为焦点的地方。
请注意，你只能在 DispatchWorkItem 到达队列头并开始执行之前取消它。</p>
<p>让我们通过从Le Internet的几个图像开始下载任务，然后取消其中的一些来演示这一点。</p>
<p>还是 <code>downloadPhotosWithCompletion(_:)</code> ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">storedError</span>: NSError?
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">downloadGroup</span> = DispatchGroup()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">addresses</span> = [overlyAttachedGirlfriendURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>                 successKidURLString,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>                 lotsOfFacesURLString]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>addresses <span style="color:#ff79c6">+=</span> addresses <span style="color:#ff79c6">+</span> addresses <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">blocks</span>: [DispatchWorkItem] = [] <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#bd93f9">0</span> ..<span style="color:#ff79c6">&lt;</span> addresses.count {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>  downloadGroup.enter()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">block</span> = DispatchWorkItem(flags: .inheritQoS) { <span style="color:#6272a4">// 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">index</span> = <span style="color:#8be9fd;font-style:italic">Int</span>(i)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">address</span> = addresses[index]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = URL(string: address)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">photo</span> = DownloadPhoto(url: url!) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>      <span style="color:#ff79c6">_</span>, error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>      <span style="color:#ff79c6">if</span> error <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>        storedError = error
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>      }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>      downloadGroup.leave()
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    PhotoManager.sharedManager.addPhoto(photo)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>  blocks.append(block)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>  DispatchQueue.main.async(execute: block) <span style="color:#6272a4">// 4</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style="color:#ff79c6">for</span> block <span style="color:#ff79c6">in</span> blocks[<span style="color:#bd93f9">3</span> ..<span style="color:#ff79c6">&lt;</span> blocks.count] { <span style="color:#6272a4">// 5</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>  <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">cancel</span> = arc4random_uniform(<span style="color:#bd93f9">2</span>) <span style="color:#6272a4">// 6</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>  <span style="color:#ff79c6">if</span> cancel == <span style="color:#bd93f9">1</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>    block.cancel() <span style="color:#6272a4">// 7</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>    downloadGroup.leave() <span style="color:#6272a4">// 8</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>downloadGroup.notify(queue: DispatchQueue.main) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>  completion?(storedError)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>}
</span></span></code></pre></div><ol>
<li>展开 <code>addresses</code> 数组以保存每个图像的三个副本</li>
<li>初始化一个 <code>blocks</code> 数组以保存 dispatch block objects 代以后使用。</li>
<li>创建一个新 <code>DispatchWorkItem</code>.
你传递一个flags参数来指定块应该从它被分派到的队列继承它的Quality of Service类。
然后你可以定义要在闭包中完成的工作。</li>
<li>你将该块异步地分派给主队列。在这个例子中，使用主队列可以更容易地取消选中的块，因为它是一个串行队列。设置调度块的代码已经在主队列上执行，因此你可以保证下次执行的时间不会超过。</li>
<li>通过切分块数组可以跳过前三个下载块。</li>
<li>在这里，你使用arc4random_uniform（）来随机选择一个介于0和1之间的数字。它就像一个硬币投掷。</li>
<li>如果随机数是1，则取消该块。这只能取消仍在队列中但尚未开始执行的块。块在执行过程中不能取消。</li>
<li>在这里，您记得从调度组中删除取消的块。</li>
</ol>
<p>构建并运行应用程序，然后从Le Internet添加图像。会看到该应用程序现在下载了三个以上的图像。每次重新运行应用程序时，额外图像的数量都会发生变化。队列中的某些其他图像下载在开始之前会被取消。</p>
<p>这是一个人为的例子，但它很好地说明了如何使用和取消分派块对象。</p>
<p>Dispatch block 可以做的事情有很多，<a href="https://developer.apple.com/reference/dispatch/dispatchworkitem">Apple&rsquo;s documentation</a></p>
<h2 id="miscellaneous-gcd-fun-其它gcd乐趣">Miscellaneous GCD Fun (其它GCD乐趣)<a class="anchorjs-link" href="#miscellaneous-gcd-fun-%e5%85%b6%e5%ae%83gcd%e4%b9%90%e8%b6%a3"></a></h2><h3 id="testing-asynchronous-code">Testing Asynchronous Code<a class="anchorjs-link" href="#testing-asynchronous-code"></a></h3><p>Xcode 中的测试是在 XCTestCase 的子类中上执行的，并在方法签名中运行任何以 <code>test</code> 开头的方法。
测试是在主线程上进行测量的，因此您可以假定每个测试都以串行方式进行。
只要给定的测试方法完成，XCTest方法就会考虑完成测试并转到下一个测试。
这意味着在下一次测试运行时，来自先前测试的任何异步代码将继续运行。</p>
<p>网络相关的代码通常是异步的，因为您不想在执行网络请求时阻塞主线程。再加上当测试方法结束时测试完成的事实，可能使测试网络代码变得困难。</p>
<p>我们来简单介绍一下测试异步代码的两种常用技术：一种使用（<strong>semaphores</strong>）信号量，另一种使用（<strong>expectations</strong>）期望值。</p>
<h3 id="semaphores">Semaphores<a class="anchorjs-link" href="#semaphores"></a></h3><p>信号量是一种古老的线程概念，由 Edsger W. Dijkstra 提出。信号量是一个复杂的话题，因为它建立在操作系统功能的提杂性之上。</p>
<p>如果你想要学习更多信号量的知识，请查看 <a href="http://greenteapress.com/semaphores/">detail discussion</a> 和 <a href="http://en.wikipedia.org/wiki/Dining_philosophers_problem">Dining Philosophers Problem</a></p>
<p>打开 <strong>GooglyPuffTests.swfit</strong> 在 <code>downloadImageURLWithString(_:) </code>  中替换如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = URL(string: urlString)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">semaphore</span> = DispatchSemaphore(value: <span style="color:#bd93f9">0</span>) <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_</span> = DownloadPhoto(url: url!) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>  <span style="color:#ff79c6">_</span>, error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>  <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span> = error {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    XCTFail(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\(</span>urlString<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c"> failed. </span><span style="color:#f1fa8c">\(</span>error.localizedDescription<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>  }   
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  semaphore.signal() <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">timeout</span> = DispatchTime.now() <span style="color:#ff79c6">+</span> .seconds(defaultTimeoutLengthInSeconds)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#ff79c6">if</span> semaphore.wait(timeout: timeout) == .timedOut { <span style="color:#6272a4">// 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>  XCTFail(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\(</span>urlString<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c"> timed out&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><ol>
<li>创建一个信号量并设置一个起始值，这表示可以访问信号量的事物的数量，而不需要增加信号量。
（注意递增信号量被称为发送信号）</li>
<li>在 compnletion 中发送一个信号，这会增加信号计数，并指示信号量可用于其他需要它的资源。</li>
<li>在给定的超时时间内等待信号，这个调用会阻塞当前的线程，直到信号被发出。此函数的非零返回码表示达到了超时。在这种情况下，测试失败，因为它认为网络不应该超过10秒才能返回 - 这是一个公平的点！</li>
</ol>
<h3 id="expectations">Expectations<a class="anchorjs-link" href="#expectations"></a></h3><p><code>XCTest</code> 框架以 <strong>expectations</strong> 的形式为异步代码测试问题提供了另一种解决方案。
这个功能可以让你设置一个 期望 - 你期望的事情会发生 - 然后开始一个异步任务。
然后，您可以让测试运行人员等待，直到异步任务将预期标记为已完成。</p>
<p>仍然是 <strong>GooglyPuffTests.swfit</strong> 的 <code>downloadImageURLWithString(_:) </code>  中替换如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">url</span> = URL(string: urlString)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">downloadExpectation</span> = 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>  expectation(description: <span style="color:#f1fa8c">&#34;Image downloaded from </span><span style="color:#f1fa8c">\(</span>urlString<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>) <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">_</span> = DownloadPhoto(url: url!) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>  <span style="color:#ff79c6">_</span>, error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>  <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span> = error {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    XCTFail(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">\(</span>urlString<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c"> failed. </span><span style="color:#f1fa8c">\(</span>error.localizedDescription<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  }   
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>  downloadExpectation.fulfill() <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>}   
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>waitForExpectations(timeout: <span style="color:#bd93f9">10</span>) { <span style="color:#6272a4">// 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>  error <span style="color:#ff79c6">in</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>  <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">error</span> = error {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    XCTFail(error.localizedDescription)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>  }   
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>} 
</span></span></code></pre></div><ol>
<li>使用 `expectation(description:) 创建一个期望。测试运行器将在失败时在测试日志中显示字符串参数，因此请描述你期望发生的情况。</li>
<li>在异步执行的闭包中调用 <code>fulfill()</code> 将预期标记为已完成。</li>
<li>调用 <code>waitForExpectations(timeout:handler:)</code> 等待 期望完成。如果超时，会被视为错误。</li>
</ol>
<p>。。。</p>
<p>最终结果与使用信号量没有太大区别，但是利用XCTest框架是一个更清晰和更可读的解决方案。</p>
<h3 id="dispatch-sources">Dispatch Sources<a class="anchorjs-link" href="#dispatch-sources"></a></h3><p><strong>Dispatch sources</strong> 是 GCD 的一个特别有趣的功能。 一个 dispatch source 可以用于监视某种类型的事件。事件可以包括 Unix 信号，文件描述符，Mach端口，VFS节点和其它不明确的东西。</p>
<p>在设置 dispatch source 时，可以告诉它要监视的事件类型以及应该执行其事件处理程序块的 dispatch queue, 然后你将一个事件处理程序分配给 dispatch source</p>
<p>创建时，dispatch source 以暂停状态开始。这允许进行额外的配置步骤，例如设置事件处理程序，一旦你配置了 dispatch source，你应该继续它来处理事件。</p>
<p>task：监视应用程序何时进入调试模式。</p>
<p>打开 <strong>PhtotCollectionViewController.swift</strong> 在 backgroundImageOpacity 全局属性声明下面添加以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#ff79c6">#if</span> <span style="color:#ff79c6">DEBUG</span> <span style="color:#6272a4">// 1</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>  <span style="color:#8be9fd;font-style:italic">var</span> <span style="color:#8be9fd;font-style:italic">signal</span>: <span style="color:#ff79c6">DispatchSourceSignal</span>? <span style="color:#6272a4">// 2</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>  <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">setupSignalHandlerFor</span> = { (<span style="color:#ff79c6">_</span> <span style="color:#ff79c6">object</span>: <span style="color:#ff79c6">AnyObject</span>) -&gt; <span style="color:#ff79c6">Void</span> <span style="color:#ff79c6">in</span> <span style="color:#6272a4">// 3</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#8be9fd;font-style:italic">let</span> <span style="color:#8be9fd;font-style:italic">queue</span> = <span style="color:#ff79c6">DispatchQueue</span>.<span style="color:#ff79c6">main</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    signal =
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>      DispatchSource.makeSignalSource(signal: <span style="color:#8be9fd;font-style:italic">Int32</span>(SIGSTOP), queue: queue) <span style="color:#6272a4">// 4</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    signal?.setEventHandler { <span style="color:#6272a4">// 5</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>      print(<span style="color:#f1fa8c">&#34;Hi, I am: </span><span style="color:#f1fa8c">\(</span>object.description!<span style="color:#f1fa8c">)</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    signal?.resume() <span style="color:#6272a4">// 6</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>  }
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#ff79c6">#endif</span>
</span></span></code></pre></div><ol>
<li>你只能在DEBUG模式下编译此代码，防止“感兴趣的各方” 对你的应用进行大量的探查。
DEBUG 通过 在 Project Settings -&gt; Build Settings -&gt; Swift Compiler - Custom Flags -&gt; Other Swift Flags -&gt; Debug 添加 <strong>-D DEBUG</strong> 来定义。
它应该已经在启动器项目中设置。</li>
<li>定义一个 <code>DispatchSourceSingal</code> 类型的 <code>singal</code> 变量来监控 Unix 信号。</li>
<li>创建一个 block 分配给 全局变量 <code>setupSignalHandlerFor</code> 用于 dispatch source 的一次性设置。</li>
<li>设置信号。您指出您有兴趣监控SIGSTOP Unix信号并处理主队列中接收到的事件 - 您会很快发现为什么。</li>
<li>如果调度源成功创建，则注册一个事件处理程序闭包，每当您收到SIGSTOP信号时都会调用它。您的处理程序打印包含类描述的消息。</li>
<li>所有源默认情况下都处于暂停状态。在这里，您告诉调度源恢复，以便它可以开始监视事件。</li>
</ol>
<p>添加下面的代码在 <code>viewDidLoad()</code> 调用 <code>super.viewDidLoad()</code> 后：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#ff79c6">#if</span> <span style="color:#ff79c6">DEBUG</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  <span style="color:#ff79c6">_</span> = setupSignalHandlerFor(<span style="color:#ff79c6">self</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#ff79c6">#endif</span>
</span></span></code></pre></div><p>构建并运行应用程序。暂停程序执行并通过点击暂停然后在Xcode调试器中播放按钮来立即恢复应用程序：</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/debugger_pause.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>查处控制台，会发现一些类似下面的东西：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>Hi, I am: &lt;GooglyPuff.PhotoCollectionViewController: 0x7fbf0af08a10&gt;
</span></span></code></pre></div><p>你的应用程序现在可以调试！这真是太棒了，但你如何在实际生活中使用它？</p>
<p>无论何时恢复应用程序，您都可以使用它来调试对象并显示数据。
当恶意攻击者将调试器附加到您的应用程序时，您也可以为您的应用程序定制安全逻辑以保护自己（或用户的数据）。</p>
<p>一个有趣的想法是将此方法用作堆栈跟踪工具来查找要在调试器中操作的对象。</p>
<p>考虑一下这种情况。当你彻底停止调试器时，你几乎不会在期望的堆栈帧上。
现在你可以随时停止调试器并在您想要的位置执行代码。如果您想要在应用程序中的某个点执行代码，而这些代码很难从调试器访问，那么这非常有用。试试看！</p>
<p>在刚刚添加的 <code>setupSignalHandlerFor</code> 块内的 <code>print()</code> 语句上放置一个断点。</p>
<p>在调试器中暂停，然后重新开始。该应用程序将达到您添加的断点。
你现在深入了 <code>PhotoCollectionViewController</code> 方法的深处。现在可以访问<code>PhotoCollectionViewController</code> 的实例来查看内容。非常方便！</p>
<p>在调试器控制台中，输入以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>(lldb) expr object.navigationItem.prompt = &#34;WOOT!&#34;
</span></span></code></pre></div><p>Xcode调试器有时可能不合作。如果您收到消息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>error: use of unresolved identifier &#39;self&#39;
</span></span></code></pre></div><p>然后，你必须努力解决LLDB中的错误。首先记下调试区域中对象的地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>(lldb) po object
</span></span></code></pre></div><p>然后手动将值转换为所需的类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>(lldb) expr let $vc = unsafeBitCast(0x7fbf0af08a10, to: GooglyPuff.PhotoCollectionViewController.self)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>(lldb) expr $vc.navigationItem.prompt = &#34;WOOT!&#34;
</span></span></code></pre></div><p>现在恢复执行应用程序。你会看到以下内容：</p>
<p><figure>
  <a class="paragraph-image">
    <img src="/media/debug_change_navitem_2.png" data-action="zoom" alt=""  loading="lazy" decoding="async">
  </a>
  
</figure></p>
<p>使用这种方法，您可以更新UI，查询类的属性，甚至执行方法 - 而无需重新启动应用程序即可进入该特殊工作流程状态。很简约。</p>
<h2 id="end">End<a class="anchorjs-link" href="#end"></a></h2><ul>
<li>完整的项目 <a href="https://koenig-media.raywenderlich.com/uploads/2016/12/GooglyPuff_Swift3_Part2_Final-1.zip">代码</a>。</li>
</ul>

        <hr style="visibility: hidden;" />
        <ul class="pager">
          
          <li class="previous">
            <a href="/posts/2018/gem-install--user-install/" data-toggle="tooltip" data-placement="top" title="Gem: 使用 --user-install 时的问题">
              Previous<br>
              <span>Gem: 使用 --user-install 时的问题</span>
            </a>
          </li>
          
          
          <li class="next">
            <a href="/posts/2018/go-moudle/" data-toggle="tooltip" data-placement="top" title="Go 1.11 新特性：Go Modules">
              Next<br>
              <span>Go 1.11 新特性：Go Modules</span>
            </a>
          </li>
          
        </ul>
        <hr style="visibility: hidden;" />

        
        



<div class="giscus" id="comments"></div>
<script src="https://giscus.app/client.js" 
  data-repo="roninro/blog" 
  data-repo-id="MDEwOlJlcG9zaXRvcnkzMDkyNTUzODI="
  data-category="Comments"
  data-category-id="DIC_kwDOEm7c1s4B_sst"
  data-mapping="pathname"
  data-strict="0" 
  data-reactions-enabled="1" 
  data-emit-metadata="0" 
  data-input-position="top"
  data-theme="light"
  crossorigin="anonymous" 
  async>
  </script>



      </div>

      
      
      
      <div class="
              col-lg-2 col-lg-offset-0
              visible-lg-block
              sidebar-container
              catalog-container">
        <div class="side-catalog">
          <hr class="hidden-sm hidden-xs">
          <h5>
            <a class="catalog-toggle" href="#">CATALOG</a>
          </h5>
          <ul class="catalog-body"></ul>
        </div>
      </div>
      
      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              sidebar-container">

        
        
        <section>
  
  
  <hr class="hidden-sm hidden-xs">
  
  <h5>FEATURED TAGS</h5>
  <div class="tags">
    
    <a href="/tags/css/">css</a>
    
    <a href="/tags/debian/">debian</a>
    
    <a href="/tags/fzf/">fzf</a>
    
    <a href="/tags/gcd/">gcd</a>
    
    <a href="/tags/gem/">gem</a>
    
    <a href="/tags/git/">git</a>
    
    <a href="/tags/go/">go</a>
    
    <a href="/tags/golang/">golang</a>
    
    <a href="/tags/hugo/">hugo</a>
    
    <a href="/tags/ios/">iOS</a>
    
    <a href="/tags/kindle/">Kindle</a>
    
    <a href="/tags/linux/">linux</a>
    
    <a href="/tags/macos/">MacOS</a>
    
    <a href="/tags/neovim/">neovim</a>
    
    <a href="/tags/runtime/">runtime</a>
    
    <a href="/tags/rust/">rust</a>
    
    <a href="/tags/ss/">ss</a>
    
    <a href="/tags/ssh/">ssh</a>
    
    <a href="/tags/swift/">Swift</a>
    
    <a href="/tags/vim/">vim</a>
    
    <a href="/tags/webhook/">webhook</a>
    
    <a href="/tags/wubi/">wubi</a>
    
    <a href="/tags/zabbix/">zabbix</a>
    
  </div>
</section>

        
        

<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href=""></a></li>
  
</ul>

      </div>
    </div>
  </div>
</article>



  
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
        


<ul class="list-inline text-center">

  
  <li>
    <a href="/index.xml">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/roninro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>
        <p class="copyright text-muted">
          Copyright &copy; RoninRo&#39;s Blog 2022
          <br>
          Powered by <a href="https://gohugo.io">Hugo</a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js" crossorigin="anonymous"></script>



<script src="/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js"></script>


<script src="/js/simple-jekyll-search.min.js"></script>


<script src="/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js"></script>






<script type="text/javascript">
  function generateCatalog(selector) {
    _containerSelector = 'div.post-container'
    
    var P = $(_containerSelector), a, n, t, l, i, c;
    a = P.find('h1,h2,h3,h4');
    
    $(selector).html('')
    
    a.each(function () {
      n = $(this).prop('tagName').toLowerCase();
      i = "#" + $(this).prop('id');
      t = $(this).text();
      c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
      l = $('<li class="' + n + '_nav"></li>').append(c);
      $(selector).append(l);
    });
    return true;
  }

  generateCatalog(".catalog-body");

  
  $(".catalog-toggle").click((function (e) {
    e.preventDefault();
    $('.side-catalog').toggleClass("fold")
  }))
</script>


<script type="text/javascript" src='/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js'></script>
<script>
   $(document).ready( function () {
    $('.catalog-body').onePageNav({
      currentClass: "active",
      changeHash: !1,
      easing: "swing",
      filter: "",
      scrollSpeed: 700,
      scrollOffset: 0,
      scrollThreshold: .2,
      begin: null,
      end: null,
      scrollChange: null,
      padding: 80
    });
  });
</script>









<script src="/zoomjs/zoom.min.js"></script>
</body>

</html>